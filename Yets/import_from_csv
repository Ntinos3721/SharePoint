using Microsoft.SharePoint;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.OleDb;
using System.Globalization;
using System.IO;
using System.Text;
using System.Threading;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;

namespace addcsv4.addcsv4wp
{
    public partial class addcsv4wpUserControl : UserControl
    {
        int dailyLimit = 000000;

        string currentWebUrl = SPContext.Current.Web.Url;
        string webapp = SPContext.Current.Web.Url;

        List<int> addedIDs = new List<int>();
        DropDownList dd_transactiontype = new DropDownList();
        DropDownList dd_currency = new DropDownList();
        DropDownList dd_producttype = new DropDownList();
        DropDownList dd_productcategory = new DropDownList();
        DropDownList dd_pnpdemandtype = new DropDownList();
        DropDownList dd_paymentterms = new DropDownList();
        DropDownList dd_countries = new DropDownList();

        protected void Page_Load(object sender, EventArgs e)
        {
            StringBuilder responseData = new StringBuilder();
            try
            {
                string baseUrl = Request.Url.Scheme + "://" + Request.Url.Authority + Request.ApplicationPath.TrimEnd('/');
                //responseData.Append("baseUrl" + baseUrl + "<br>");

                using (SPSite site = SPContext.Current.Site)
                {
                    using (SPWeb web = site.OpenWeb())
                    {
                        //SPListCollection collSiteLists = web.Lists;
                        //foreach (SPList oList in collSiteLists)
                        //        {
                        //get your each list here
                        //          responseData.Append("List TitleQ "+oList.Title + "<br>");
                        //      }
                        //oros plirvmhs


                        if (!Page.IsPostBack)
                        {
                            SPList list = web.Lists["branches"];
                            dd_katastimata.DataSource = list.Items;
                            dd_katastimata.DataValueField = "Title";
                            dd_katastimata.DataTextField = "Title";
                            dd_katastimata.DataBind();

                            SPList grouplist = web.Lists["group"];
                            dd_group.DataSource = grouplist.Items;
                            dd_group.DataValueField = "Title";
                            dd_group.DataTextField = "Title";
                            dd_group.DataBind();

                            SPList entoleaslist = web.Lists["entoleas"];
                            dd_entoleas.DataSource = entoleaslist.Items;
                            dd_entoleas.DataValueField = "Title";
                            dd_entoleas.DataTextField = "Title";
                            dd_entoleas.DataBind();

                            SPList mdlist = web.Lists["md"];
                            dd_md.DataSource = mdlist.Items;
                            dd_md.DataValueField = "Title";
                            dd_md.DataTextField = "Title";
                            dd_md.DataBind();
                        }
                        SPList transactiontypelist = web.Lists["transactiontype"];
                        dd_transactiontype.DataSource = transactiontypelist.Items;
                        dd_transactiontype.DataValueField = "Title";
                        dd_transactiontype.DataTextField = "Title";
                        dd_transactiontype.DataBind();

                        SPList currencylist = web.Lists["currency"];
                        dd_currency.DataSource = currencylist.Items;
                        dd_currency.DataValueField = "Title";
                        dd_currency.DataTextField = "Title";
                        dd_currency.DataBind();


                        SPList producttypelist = web.Lists["producttype"];
                        dd_producttype.DataSource = producttypelist.Items;
                        dd_producttype.DataValueField = "Title";
                        dd_producttype.DataTextField = "Title";
                        dd_producttype.DataBind();

                        SPList productcategorylist = web.Lists["productcategory"];
                        dd_productcategory.DataSource = productcategorylist.Items;
                        dd_productcategory.DataValueField = "Title";
                        dd_productcategory.DataTextField = "Title";
                        dd_productcategory.DataBind();

                        SPList pnpdemandtypelist = web.Lists["pnpdemandtype"];
                        dd_pnpdemandtype.DataSource = pnpdemandtypelist.Items;
                        dd_pnpdemandtype.DataValueField = "Title";
                        dd_pnpdemandtype.DataTextField = "Title";
                        dd_pnpdemandtype.DataBind();

                        SPList paymenttermslist = web.Lists["paymentterms"];
                        dd_paymentterms.DataSource = paymenttermslist.Items;
                        dd_paymentterms.DataValueField = "Title";
                        dd_paymentterms.DataTextField = "Title";
                        dd_paymentterms.DataBind();

                        SPList countrieslist = web.Lists["countries"];
                        dd_countries.DataSource = countrieslist.Items;
                        dd_countries.DataValueField = "Title";
                        dd_countries.DataTextField = "Title";
                        dd_countries.DataBind();

                        //Label1.Text = dd_transactiontype.Items.FindByText("01").Text


                    }

                }
            }
            catch (Exception ex)
            {
                responseData.Append(" page load error :" + ex.ToString() + "<br>");

            }
            finally
            {
                Label1.Text = responseData.ToString();
            }
        }


        protected void UpdateButton_Click(object sender, EventArgs e)
        {
            decimal mySumToEuro = 0m;

            try
            {
                StringBuilder responseData = new StringBuilder();
                //string dummyurl = "http://dms/TODO/pnpdemands/";
                //string dummyurl2 = dummyurl.Substring(dummyurl.IndexOf("://"), dummyurl.Length - 4);
                //string parentsubsites = webapp.Substring(webapp.IndexOf("://"), webapp.Length - webapp.IndexOf("://"));

                string katastimaurl2 = "";
                string fname = "empty";
                decimal sum = 0;
                decimal sumineuro = 0;
                //string thousands = "";
                //string dekadika = "";
                TimeSpan ts = DateTime.Parse(datepel.SelectedDate.ToString()) - DateTime.Now;
                int numberOfDays = ts.Days;

                if (ts.Days < 1 && ts.Hours < 0 && ts.Days > -32)
                {
                    if (CheckAFM(afm.Text))
                    {
                        if (FileUpload1.HasFile)
                        {
                            #region hasfile
                            int noLines = 0;
                            fname = FileUpload1.PostedFile.FileName.ToString();
                            #region comment out
                            //FileUpload1.SaveAs("c:\\temp\\myfile");
                            //int fileLen = FileUpload1.PostedFile.ContentLength;
                            //byte[] input = new byte[fileLen - 1];
                            //input = FileUpload1.FileBytes;
                            //var str1 = System.Text.Encoding.Default.GetString(input);
                            //responseData.Append("result Default:" + str1 + "<br>");
                            //var str2 = System.Text.Encoding.UTF8.GetString(input);
                            //responseData.Append("result UTF8 :" + str2 + "<br>");
                            //var str3 = System.Text.Encoding.ASCII.GetString(input);
                            //responseData.Append("result ASCII:" + str3 + "<br>");
                            //var str4 = System.Text.Encoding.GetEncoding("iso-8859-1").GetString(input);
                            //responseData.Append("result 8859:" + str4 + "<br>");
                            //var str5 = System.Text.Encoding.Unicode.GetString(input);
                            //responseData.Append("result Unicode:" + str5 + "<br>");
                            //Encoding encoding = Encoding.Default;
                            //String original = String.Empty;

                            //original = stream.ReadToEnd();
                            //responseData.Append("original:" + original + "<br>");
                            //encoding = stream.CurrentEncoding;
                            //responseData.Append("encoding:" + encoding + "<br>");



                            //Encoding wind1252 = Encoding.GetEncoding(1252);
                            //Encoding Unicode = Encoding.Unicode;
                            //Encoding ASCII = Encoding.ASCII;
                            //Encoding utf8 = Encoding.UTF8;
                            //byte[] wind1252Bytes = ReadFile("c:\\temp\\myfile");
                            //byte[] utf8Bytes = Encoding.Convert(wind1252, utf8, input);
                            //string utf8String = Encoding.ASCII.GetString(utf8Bytes);

                            //StreamReader stream = new StreamReader(FileUpload1.PostedFile.InputStream, System.Text.Encoding.UTF8);
                            //StreamReader stream = new StreamReader(FileUpload1.PostedFile.InputStream, Encoding.GetEncoding("iso-8859-1"));
                            //StreamReader stream2 = new StreamReader(FileUpload1.PostedFile.InputStream, System.Text.Encoding.Unicode);
                            //StreamReader stream3 = new StreamReader(FileUpload1.PostedFile.InputStream, System.Text.Encoding.ASCII);
                            //StreamReader stream4 = new StreamReader(FileUpload1.PostedFile.InputStream, System.Text.Encoding.GetEncoding(1252));
                            //line = stream.ReadLine();
                            //string x = stream.ReadToEnd();  // added to view content of input stream
                            #endregion
                            if (FileUpload1.PostedFile.FileName.ToLower().Contains("xls"))
                            {
                                Log(string.Format("Start-- Κατάστημα: {0}, ΑΦΜ: {1}, File: {2}", dd_katastimata.SelectedValue, afm.Text, Path.GetFileName(FileUpload1.PostedFile.FileName)));

                                string strFilePath = "";
                                try
                                {

                                    SPSecurity.RunWithElevatedPrivileges(delegate()
                                    {
                                        bool filevalidated = true;

                                        string sheetname = "ΕΕΤΣ_ΥΕΤΣ_" + afm.Text + "$";

                                        Stream strm = FileUpload1.PostedFile.InputStream;
                                        try
                                        {
                                            strFilePath = "C:\\temp\\" + sheetname.Substring(0, sheetname.Length - 1);// Path.GetFileName(Path.GetTempFileName()); 
                                            if (File.Exists(strFilePath))
                                            {
                                                try
                                                {
                                                    File.Delete(strFilePath);
                                                }
                                                catch (Exception ex)
                                                {
                                                    Log(string.Format("(241): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                    responseData.Append("can not delete pre existing file:" + strFilePath + "<br");
                                                    filevalidated = false;
                                                }
                                            }
                                            FileUpload1.SaveAs(strFilePath);
                                        }
                                        catch (Exception ex)
                                        {
                                            Log(string.Format("(250): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                            responseData.Append("Πρόβλημα στην αποθήκeυση του Excel!" + strFilePath + "<br>");
                                            filevalidated = false;
                                        }

                                        string provider = "";

                                        //jdp 18-2-2013 string provider = "Provider=Microsoft.Jet.OleDb.4.0";
                                        //jdp 18-2-2013 To upload xls & xlsx and import in x64 system
                                        //jdp 18-2-2013 if (uploadExcel.FileName.ToLower().EndsWith(".xlsx"))
                                        //jdp 18-2-2013 {
                                        provider = "Provider=Microsoft.ACE.OLEDB.12.0";
                                        //jdp 18-2-2013 }

                                        string strConnectionString = string.Format(@"{0};Data Source={1};Extended Properties=""Excel 8.0;HDR=Yes;IMEX=1""", provider, strFilePath);
                                        OleDbConnection cnCSV = new OleDbConnection(strConnectionString);


                                        try
                                        {
                                            // attempt to open as excel format
                                            cnCSV.Open();
                                        }
                                        catch (Exception ex)
                                        {
                                            Log(string.Format("(275): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                            // now attempt to open the file as HTML format
                                            cnCSV.ConnectionString = cnCSV.ConnectionString.Replace("Excel 8.0", "HTML Import");
                                            cnCSV.Open();
                                        }

                                        //DataTable dtSchema = cnCSV.GetOleDbSchemaTable(OleDbSchemaGuid.Tables, new object[] { null, null, null, "TABLE" });
                                        //var Sheet1 = dtSchema.Rows[0].Field<string>("TABLE_NAME");

                                        OleDbCommand cmdSelect = new OleDbCommand(string.Format(@"SELECT * FROM [{0}]", sheetname), cnCSV);
                                        OleDbDataAdapter daCSV = new OleDbDataAdapter();

                                        daCSV.SelectCommand = cmdSelect;

                                        DataTable dtCSV = new DataTable();
                                        try
                                        {
                                            daCSV.Fill(dtCSV);
                                            cnCSV.Close();
                                            daCSV = null;
                                            try
                                            {
                                                File.Delete(strFilePath);
                                            }
                                            catch (Exception ex)
                                            {
                                                Log(string.Format("(300): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                responseData.Append("can not delete file:" + strFilePath + "<br");
                                                filevalidated = false;
                                            }
                                        }
                                        catch (Exception ex)
                                        {
                                            Log(string.Format("(308): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                            responseData.Append("Λανθασμένο ΑΦΜ στο φύλλο του Excel!");
                                            filevalidated = false;
                                        }

                                        #region init
                                        //Guid g;
                                        string currency = "";
                                        string entoleas = "";
                                        string katastimaurl = "";
                                        string katastimaurl4source = "";
                                        string dikaiouxos = "";
                                        string sinoliki = "";
                                        string megisti = "";
                                        addedIDs.Clear();

                                        mySumToEuro = GetSumToEuro(dtCSV, responseData);
                                        if (mySumToEuro == -1)
                                        {
                                            responseData.Append("<font color='red'>Η διαδικασία σταμάτησε, λόγω σφάλματος: " + mySumToEuro + "<br>Βεβαιωθείτε ότι τα ποσά στη στήλη Ποσό είναι στη σωστή μορφή.</font>");
                                            return;
                                        }

                                        #endregion


                                        //Console.WriteLine("csv rows:" + dtCSV.Rows.Count);
                                        CultureInfo currentCulture = Thread.CurrentThread.CurrentCulture;
                                        Log("Culture:" + currentCulture.Name);

                                        RemoveRedundantColumns(dtCSV); //FYI: added 20160112

                                        foreach (DataRow row in dtCSV.Rows)
                                        {
                                            //FYI: changes -- 20151203
                                            if (AreAllValidColumnsEmpty(row) || !FirstColumnHasValue(row))
                                                continue;

                                            if (!filevalidated)
                                            {
                                                responseData.Append("Λάθος στην γραμμή :" + noLines + " !");
                                                break;
                                            }
                                            #region for each datarow in excel

                                            //FYI: changes -- 20151203
                                            if (FirstColumnHasValue(row))
                                            {
                                                noLines++;
                                            }

                                           

                                            if (dtCSV.Columns.Count == 19)
                                            {
                                                #region columns is ok
                                                using (SPSite oSite = new SPSite(webapp))
                                                {
                                                    using (SPWeb oWeb = oSite.RootWeb)
                                                    {
                                                        SPList oList = oWeb.Lists["TODO"];
                                                        if (!row[16].ToString().Contains("Σύνολο:") && row[1].ToString().Length != 0)
                                                        {
                                                            if (!afm.Text.Equals(row[1].ToString()) && row[1].ToString().Length != 0)
                                                            {
                                                                #region afm
                                                                responseData.Append("στην γραμμή :" + noLines + " υπάρχει λάθος ΑΦΜ <br>");
                                                                filevalidated = false;
                                                                //foreach (int itmID in addedIDs)
                                                                //{
                                                                //    SPListItem tobeDeleted = oList.GetItemById(itmID);
                                                                //    tobeDeleted.Delete();
                                                                //    responseData.Append("εγγραφή με id " + itmID.ToString() + " διαγράφηκε λόγω διαφορετικων ΑΦΜ στο ίδιο αρχείο!<br>");
                                                                //}
                                                                break;
                                                                #endregion
                                                            }
                                                            else
                                                            {
                                                                #region else
                                                                try
                                                                {
                                                                    //SPListItem oSPListItem = oList.Items.Add("/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                    //SPListItem oSPListItem = oList.Items.Add();
                                                                    SPListItem oSPListItem;
                                                                    
                                                                    if (IsTestEnvironment(webapp))
                                                                    {
                                                                        oSPListItem = oList.AddItem("/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                    }
                                                                    else
                                                                    {
                                                                        oSPListItem = oList.AddItem("/TODO/TODO/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                    }
                                                                    //SPListItem oSPListItem = oList.AddItem();
                                                                    //responseData.Append("<br>/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString());
                                                                    //responseData.Append("<br>/TODO/pnpdemands/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString());

                                                                    String kodikosaitimatos = "";
                                                                    //string fakelos = "CreationDate-BranchCode-AFM-CDI-Currency-Group";
                                                                    //20150910-105-094008102-0000609155-EUR-01
                                                                    if (noLines < 2)
                                                                    {
                                                                        #region line is one for checking

                                                                        currency = row[6].ToString().ToUpper();
                                                                        entoleas = row[0].ToString().ToUpper();
                                                                        dikaiouxos = row[3].ToString().ToUpper();

                                                                        megisti = row[17].ToString().ToUpper();
                                                                        sinoliki = row[18].ToString().ToUpper();

                                                                        kodikosaitimatos = DateTime.Now.ToString("yyyyMMdd") + "-" +
                                                                        dd_katastimata.SelectedValue.ToString().Substring(0, 3) + "-" +
                                                                        afm.Text + "-" +
                                                                        cdpel.Text.ToUpper() + "-" +
                                                                        row[6].ToString().ToUpper() + "-" +
                                                                        dd_group.SelectedValue.ToString();

                                                                        oSPListItem["Κωδικός Αιτήματος"] = kodikosaitimatos;
                                                                        oSPListItem["CDI Πελάτη"] = cdpel.Text;
                                                                        oSPListItem["Κωδικός Καταστήματος"] = dd_katastimata.SelectedValue.ToString();
                                                                        oSPListItem["Group"] = dd_group.SelectedValue.ToString();
                                                                        oSPListItem["Είδος Εντολέα"] = dd_entoleas.SelectedValue.ToString();
                                                                        oSPListItem["Μονάδα Διαχείρισης"] = dd_md.SelectedValue.ToString();
                                                                        oSPListItem["Ημερομηνία υποβολής αιτήματος από τον Πελάτη"] = datepel.SelectedDate.ToString("yyyy-MM-dd");
                                                                        oSPListItem["Title"] = "Αίτημα Συναλλαγής";
                                                                        oSPListItem["Πελάτης/Εντολέας"] = row[0].ToString();
                                                                        oSPListItem["ΑΦΜ"] = row[1].ToString();
                                                                        oSPListItem["Προς Καταχώρηση από Κ/Υ"] = ddKY.SelectedValue; //FYI:20160217

                                                                        if (dd_transactiontype.Items.FindByText(row[2].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Είδος Συναλλαγής"] = row[2].ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Λάθος στο Είδος Συναλλαγής :" + row[2].ToString() + "<br>");
                                                                            responseData.Append("Yποστηριζόμενα Είδη Συναλλαγής :<br>");
                                                                            foreach (ListItem li in dd_transactiontype.Items)
                                                                            {
                                                                                responseData.Append(li.Value + "<br>");
                                                                            }
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        oSPListItem["Δικαιούχος Εντολής"] = row[3].ToString();

                                                                        if (dd_countries.Items.FindByText(row[4].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Χώρα Προορισμού Κεφαλαίων"] = row[4].ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενο λεκτικό Χώρας Προορισμού Κεφαλαίων :" + row[4].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }


                                                                        oSPListItem["Αιτιολογία Συναλλαγής"] = row[5].ToString();

                                                                        if (dd_currency.Items.FindByText(row[6].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Νόμισμα"] = row[6].ToString().ToUpper();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενο λεκτικό νομίσματος :" + row[6].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        try
                                                                        {
                                                                            #region old Ποσό Παραστατικού

                                                                            if (row[16].ToString().Length > 2)
                                                                            {
                                                                                //Log("476");

                                                                                if (row[16].ToString().Substring(row[16].ToString().Length - 3, 1).Equals("."))
                                                                                {
                                                                                    oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                    //Log(string.Format("(480) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals(","))
                                                                                    {
                                                                                        oSPListItem["Ποσό Παραστατικού"] = row[16].ToString().Replace(",", ".") + "0";
                                                                                        //Log(string.Format("(487) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals("."))
                                                                                        {
                                                                                            oSPListItem["Ποσό Παραστατικού"] = row[16].ToString() + "0";
                                                                                            //Log(string.Format("(494) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            oSPListItem["Ποσό Παραστατικού"] = Math.Round(decimal.Parse(row[16].ToString()), 2);
                                                                                            //Log(string.Format("(500) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                //Log(string.Format("(508) line: {0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                            }

                                                                            #endregion
                                                                            //FYI: 20151209
                                                                            //oSPListItem["Ποσό Παραστατικού"] = this.ToDecimal(row[16].ToString(), noLines);

                                                                        }
                                                                        catch (Exception ex)
                                                                        {
                                                                            Log(string.Format("(518): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                            responseData.Append("Λάθος στο Ποσό Παραστατικού :" + row[16].ToString() + "<br>"); // check first line
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        sum = decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString());
                                                                        //Log(string.Format("(523) line: {0}, Ποσό Παραστατικού:{1}, sum:{2}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString(), sum));
                                                                        //sum = this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);


                                                                        if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                        {
                                                                            try
                                                                            {

                                                                                oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString()), 2);
                                                                                //Log(string.Format("(534) line:{0}, Ισότιμο σε ΕΥΡΩ:{1}, sum:{2}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), sum));
                                                                                //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);
                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(540): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                responseData.Append("Λάθος στο Ισότιμο σε ΕΥΡΩ :" + row[16].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }


                                                                        }//edn if eur
                                                                        else
                                                                        {
                                                                            try
                                                                            {
                                                                                //TODO:
                                                                                SPList rates = oWeb.Lists["Rates"];
                                                                                SPQuery oQuery = new SPQuery();
                                                                                oQuery.Query = "<Where><And><Eq><FieldRef Name='Title'/>" +
                                                                                    "<Value Type='Text'>" + row[6].ToString().Trim() + "</Value></Eq>" +
                                                                                    "<Eq><FieldRef Name='RateDate'/><Value Type='DateTime'>" + DateTime.Now.ToString("yyyy-MM-dd") + "</Value></Eq></And></Where>";
                                                                                SPListItemCollection collListItems = rates.GetItems(oQuery);

                                                                                foreach (SPListItem oListItem in collListItems)
                                                                                {
                                                                                    if (oListItem["RateMTF"].ToString() != null)
                                                                                    {
                                                                                        if (decimal.Parse(oListItem["RateMTF"].ToString()) > 0)
                                                                                        {
                                                                                            //Log(string.Format("(563) line:{0}, RateMTF:{1}", noLines, decimal.Parse(oListItem["RateMTF"].ToString()), 2));
                                                                                            oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString()) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                            //Log(string.Format("(565) line:{0}, Ισότιμο σε ΕΥΡΩ:{1}, sum:{2}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), sum));
                                                                                            //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);

                                                                                            oSPListItem["rate"] = oListItem["RateMTF"];
                                                                                            oSPListItem["ratedate"] = DateTime.Parse(oListItem["RateDate"].ToString()).ToString("dd/MM/yyyy");
                                                                                        }
                                                                                    }
                                                                                }

                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(580): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                responseData.Append("Λάθος στην μετατροπή από " + row[6].ToString() + " λόγω του ποσού:" + oSPListItem["Ποσό Παραστατικού"].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }
                                                                        }

                                                                        if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] != null)
                                                                        {
                                                                            sumineuro = decimal.Parse(oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString());
                                                                            //sumineuro = this.ToDecimal(oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), noLines);
                                                                            //Log(string.Format("(587) line:{0}, sumineuro:{1}", noLines, sumineuro));
                                                                        }

                                                                        if (dd_pnpdemandtype.Items.FindByText(row[7].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Είδος Παραστατικού"] = row[7].ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενο Είδος Παραστατικού :" + row[7].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        oSPListItem["Αριθμός Παραστατικού"] = row[8].ToString();

                                                                        string dummydate2 = "";
                                                                        int length = 0;
                                                                        int pos1 = 0;
                                                                        int pos2 = 0;
                                                                        string dummydate = "";
                                                                        DateTime dummydate3;
                                                                        if (DateTime.TryParse(row[9].ToString(), out dummydate3))
                                                                        {
                                                                            oSPListItem["Ημερομηνία Παραστατικού"] = dummydate3;
                                                                        }
                                                                        else
                                                                        {
                                                                            try
                                                                            {
                                                                                dummydate2 = row[9].ToString();
                                                                                length = dummydate2.Length;
                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);
                                                                                oSPListItem["Ημερομηνία Παραστατικού"] = dummydate;
                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(630): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                responseData.Append("Λάθος στην Ημερομηνία Παραστατικού :" + dummydate + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }
                                                                        }

                                                                        if (dd_productcategory.Items.FindByText(row[10].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Κατηγορία Προϊόντος"] = row[10].ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενη Κατηγορία Προϊόντος :" + row[10].ToString() + "<br>");
                                                                            responseData.Append("Yποστηριζόμενες Κατηγορίες Προϊόντος :<br>");
                                                                            foreach (ListItem li in dd_productcategory.Items)
                                                                            {
                                                                                responseData.Append(li.Value + "<br>");
                                                                            }
                                                                            filevalidated = false;
                                                                            break;
                                                                        }


                                                                        if (dd_producttype.Items.FindByText(row[11].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Είδος Προϊόντος"] = row[11].ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενο Είδος Προϊόντος :" + row[11].ToString() + "<br>");
                                                                            responseData.Append("Yποστηριζόμενα Είδη Προϊόντος :<br>");
                                                                            foreach (ListItem li in dd_producttype.Items)
                                                                            {
                                                                                responseData.Append(li.Value + "<br>");
                                                                            }

                                                                            filevalidated = false;
                                                                            break;
                                                                        }



                                                                        if (DateTime.TryParse(row[12].ToString(), out dummydate3))
                                                                        {
                                                                            oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate3;
                                                                        }
                                                                        else
                                                                        {
                                                                            try
                                                                            {
                                                                                dummydate2 = row[12].ToString();
                                                                                length = dummydate2.Length;
                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);
                                                                                oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate;
                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(690): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                responseData.Append("Λάθος στην Ημερομηνία Λήξης Τιμολογίου :" + dummydate + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }
                                                                        }
                                                                        if (dd_paymentterms.Items.FindByText(row[13].ToString()) != null)
                                                                        {
                                                                            oSPListItem["Όρος Πληρωμής"] = row[13].ToString().ToUpper();
                                                                        }
                                                                        else
                                                                        {
                                                                            responseData.Append("Μη υποστηριζόμενος Όρος Πληρωμής: " + row[13].ToString() + " στην γραμμή " + noLines + "<br>");
                                                                            responseData.Append("Yποστηριζόμενοι Όροι Πληρωμής :<br>");
                                                                            foreach (ListItem li in dd_paymentterms.Items)
                                                                            {
                                                                                responseData.Append(li.Value + "<br>");
                                                                            }
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        oSPListItem["Σχόλια Πληρωμής"] = row[14].ToString();
                                                                        if (DateTime.TryParse(row[15].ToString(), out dummydate3))
                                                                        {
                                                                            oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate3;
                                                                        }
                                                                        else
                                                                        {
                                                                            try
                                                                            {
                                                                                dummydate2 = row[15].ToString();
                                                                                length = dummydate2.Length;
                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);

                                                                                oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate;
                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(731): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                //responseData.Append("Λάθος στήν Ημερομηνία Παράδοσης Προϊόντος :" + dummydate + "<br>");
                                                                                //filevalidated = false;
                                                                                //break;
                                                                            }
                                                                        }

                                                                        try
                                                                        {
                                                                            oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"] = Math.Round(decimal.Parse(row[17].ToString()), 2);
                                                                        }
                                                                        catch (Exception ex)
                                                                        {
                                                                            Log(string.Format("(744): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                            responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }
                                                                        if (decimal.Parse(oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"].ToString()) < 0)
                                                                        {
                                                                            responseData.Append("Λάθος στήν Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        try
                                                                        {
                                                                            oSPListItem["Συνολική Ετήσια Αξία"] = Math.Round(decimal.Parse(row[18].ToString()), 2);
                                                                        }
                                                                        catch (Exception ex)
                                                                        {
                                                                            Log(string.Format("(762): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                            responseData.Append("Λάθος στο Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }
                                                                        if (decimal.Parse(oSPListItem["Συνολική Ετήσια Αξία"].ToString()) < 0)
                                                                        {
                                                                            responseData.Append("Λάθος στήν Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }
                                                                        try
                                                                        {
                                                                            oSPListItem["Όριο"] = Math.Round(decimal.Parse(row[17].ToString()) * 140 / 100, 2); //FYI: AG request
                                                                        }
                                                                        catch (Exception ex)
                                                                        {
                                                                            Log(string.Format("(779): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                            responseData.Append("Λάθος στο Μηνιαίο Όριο ΠΝΠ :" + row[17].ToString() + "<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }
                                                                        if (decimal.Parse(oSPListItem["Συνολική Ετήσια Αξία"].ToString()) <
                                                                            decimal.Parse((oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"].ToString())))
                                                                        {
                                                                            responseData.Append("Λάθος: η Συνολική Ετήσια Αξία (" + row[18].ToString() + ") είναι μικρότερη από την Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό (" + row[17].ToString() + ")<br>");
                                                                            filevalidated = false;
                                                                            break;
                                                                        }

                                                                        #region commentout
                                                                        //if (FileUpload2.HasFile == true && noLines < 2)
                                                                        //{
                                                                        //    string fname2 = "Αίτηση_" + Path.GetFileName(FileUpload2.PostedFile.FileName.ToString());
                                                                        //    byte[] textfile2 = FileUpload2.FileBytes;
                                                                        //    oSPListItem.Attachments.Add(fname2, textfile2);
                                                                        //}

                                                                        //if (FileUpload3.HasFile == true && noLines < 2)
                                                                        //{
                                                                        //    string fname3 = "Δήλωση_" + Path.GetFileName(FileUpload3.PostedFile.FileName.ToString());
                                                                        //    byte[] textfile3 = FileUpload3.FileBytes;
                                                                        //    oSPListItem.Attachments.Add(fname3, textfile3);
                                                                        //}

                                                                        //if (FileUpload4.HasFile == true && noLines < 2)
                                                                        //{
                                                                        //    string fname4 = "Τιμ_" + Path.GetFileName(FileUpload4.PostedFile.FileName.ToString());
                                                                        //    byte[] textfile4 = FileUpload4.FileBytes;
                                                                        //    oSPListItem.Attachments.Add(fname4, textfile4);
                                                                        //}
                                                                        #endregion

                                                                        //oSPListItem.Update();
                                                                        //addedIDs.Add(oSPListItem.ID);
                                                                        katastimaurl = webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                        if (katastimaurl.Length < 255)
                                                                        {
                                                                            katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                        }
                                                                        else
                                                                        {
                                                                            string katastimaurlsmall = oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                            if (katastimaurlsmall.Length < 255)
                                                                            {
                                                                                katastimaurl4source = HttpUtility.UrlEncode(katastimaurlsmall);
                                                                            }
                                                                            else
                                                                            {
                                                                                katastimaurl4source = "/";
                                                                            }
                                                                        }
                                                                        //katastimaurl4source = webapp + "/" + oList.RootFolder.Url.ToString();
                                                                        katastimaurl2 = "Κατάστημα: <a href='" + webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString() + "?Source=" + katastimaurl4source + "' target=_blank >" + dd_katastimata.SelectedValue.ToString() + "</a><br>";
                                                                        //responseData.Append("εγγραφή: <a href='" + webapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + "<br>");
                                                                        if (filevalidated)
                                                                        {
                                                                            if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                            {
                                                                                responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                            }
                                                                            else
                                                                            {
                                                                                if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                                }
                                                                                else
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                                }
                                                                            }
                                                                        }// end if filevalidated
                                                                        else
                                                                        {
                                                                            if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                            {
                                                                                responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι Λάθος!<br>");
                                                                            }
                                                                            else
                                                                            {
                                                                                if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι Λάθος!<br>");
                                                                                }
                                                                                else
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " στην γραμμή " + noLines + " είναι Λάθος!<br>");
                                                                                }
                                                                            }
                                                                        }
                                                                        #endregion
                                                                    }
                                                                    else
                                                                    {
                                                                        if (row[3].ToString().ToUpper().Equals(dikaiouxos) &&
                                                                            row[6].ToString().ToUpper().Equals(currency) &&
                                                                            row[0].ToString().ToUpper().Equals(entoleas) &&
                                                                            row[17].ToString().ToUpper().Equals(megisti) &&
                                                                            row[18].ToString().ToUpper().Equals(sinoliki) &&
                                                                            row[0].ToString().Length != 0 &&
                                                                            row[6].ToString().Length != 0)
                                                                        {
                                                                            #region currency and entoleas is repeated ok and dikoaiouxos is ok
                                                                            kodikosaitimatos = DateTime.Now.ToString("yyyyMMdd") + "-" +
                                                                        dd_katastimata.SelectedValue.ToString().Substring(0, 3) + "-" +
                                                                        afm.Text + "-" +
                                                                        cdpel.Text.ToUpper() + "-" +
                                                                        row[6].ToString().ToUpper() + "-" +
                                                                        dd_group.SelectedValue.ToString();

                                                                            oSPListItem["Κωδικός Αιτήματος"] = kodikosaitimatos;
                                                                            oSPListItem["CDI Πελάτη"] = cdpel.Text;
                                                                            oSPListItem["Κωδικός Καταστήματος"] = dd_katastimata.SelectedValue.ToString();
                                                                            oSPListItem["Group"] = dd_group.SelectedValue.ToString();
                                                                            oSPListItem["Είδος Εντολέα"] = dd_entoleas.SelectedValue.ToString();
                                                                            oSPListItem["Μονάδα Διαχείρισης"] = dd_md.SelectedValue.ToString();
                                                                            oSPListItem["Ημερομηνία υποβολής αιτήματος από τον Πελάτη"] = datepel.SelectedDate.ToString("yyyy-MM-dd");
                                                                            oSPListItem["Title"] = "Αίτημα Συναλλαγής";

                                                                            oSPListItem["Πελάτης/Εντολέας"] = row[0].ToString();
                                                                            oSPListItem["ΑΦΜ"] = row[1].ToString();
                                                                            oSPListItem["Είδος Συναλλαγής"] = row[2].ToString();
                                                                            oSPListItem["Δικαιούχος Εντολής"] = row[3].ToString();
                                                                            oSPListItem["Χώρα Προορισμού Κεφαλαίων"] = row[4].ToString();
                                                                            oSPListItem["Αιτιολογία Συναλλαγής"] = row[5].ToString();
                                                                            oSPListItem["Νόμισμα"] = row[6].ToString().ToUpper();
                                                                            oSPListItem["Προς Καταχώρηση από Κ/Υ"] = ddKY.SelectedValue; //FYI:20160217

                                                                            try
                                                                            {
                                                                                #region old Ποσό Παραστατικού

                                                                                if (row[16].ToString().Length > 2)
                                                                                {
                                                                                    if (row[16].ToString().Substring(row[16].ToString().Length - 3, 1).Equals("."))
                                                                                    {
                                                                                        oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                        //Log(string.Format("(908) line:{0}, Ποσό Παραστατικού:{1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals(","))
                                                                                        {
                                                                                            oSPListItem["Ποσό Παραστατικού"] = row[16].ToString().Replace(",", ".") + "0";
                                                                                            //Log(string.Format("(915) line:{0}, Ποσό Παραστατικού:{1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals("."))
                                                                                            {
                                                                                                oSPListItem["Ποσό Παραστατικού"] = row[16].ToString() + "0";
                                                                                                //Log(string.Format("(922) line:{0}, Ποσό Παραστατικού:{1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                oSPListItem["Ποσό Παραστατικού"] = Math.Round(decimal.Parse(row[16].ToString()), 2);
                                                                                                //Log(string.Format("(927) line:{0}, Ποσό Παραστατικού:{1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                    //Log(string.Format("(935) line:{0}, Ποσό Παραστατικού:{1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                }

                                                                                #endregion
                                                                                //FYI: 20151209
                                                                                //oSPListItem["Ποσό Παραστατικού"] = this.ToDecimal(row[16].ToString(), noLines);

                                                                                //FYI: 20151209
                                                                                sum += decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString());
                                                                                //sum += this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);
                                                                                //Log(string.Format("(945) line:{0}, Ποσό Παραστατικού:{1}, sum:{2}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString(), sum));
                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                Log(string.Format("(744): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                responseData.Append("Λάθος στο Ποσό Παραστατικού :" + row[16].ToString() + "<br>"); // check other lines
                                                                                filevalidated = false;
                                                                                break;
                                                                            }
                                                                            if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                            {
                                                                                try
                                                                                {
                                                                                    //FYI: 20151209
                                                                                    oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(row[16].ToString()), 2);
                                                                                    //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = this.ToDecimal(row[16].ToString(), noLines);
                                                                                    Log(string.Format("(960) line:{0}, Ισότιμο σε ΕΥΡΩ:{1}, sum:{2}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), sum));
                                                                                }
                                                                                catch (Exception ex)
                                                                                {
                                                                                    Log(string.Format("(975): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                    responseData.Append("Λάθος στο Ισότιμο σε ΕΥΡΩ :" + ex.ToString() + "<br>");
                                                                                    filevalidated = false;
                                                                                    break;
                                                                                }



                                                                            }//edn if eur
                                                                            else
                                                                            {
                                                                                try
                                                                                {
                                                                                    SPList rates = oWeb.Lists["Rates"];
                                                                                    SPQuery oQuery = new SPQuery();
                                                                                    oQuery.Query = "<Where><And><Eq><FieldRef Name='Title'/>" +
                                                                                        "<Value Type='Text'>" + row[6].ToString() + "</Value></Eq>" +
                                                                                        "<Eq><FieldRef Name='RateDate'/><Value Type='DateTime'>" + DateTime.Now.ToString("yyyy-MM-dd") + "</Value></Eq></And></Where>";
                                                                                    SPListItemCollection collListItems = rates.GetItems(oQuery);

                                                                                    foreach (SPListItem oListItem in collListItems)
                                                                                    {
                                                                                        if (oListItem["RateMTF"].ToString() != null)
                                                                                        {
                                                                                            if (decimal.Parse(oListItem["RateMTF"].ToString()) > 0)
                                                                                            {
                                                                                                //Log(string.Format("(990) line:{0}, RateMTF:{1}", noLines, decimal.Parse(oListItem["RateMTF"].ToString()), 2));
                                                                                                oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString()) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                //Log(string.Format("(992) line:{0}, Ισότιμο σε ΕΥΡΩ:{1}, sum:{2}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), sum));

                                                                                                oSPListItem["rate"] = oListItem["RateMTF"];
                                                                                                oSPListItem["ratedate"] = DateTime.Parse(oListItem["RateDate"].ToString()).ToString("dd/MM/yyyy");
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                }
                                                                                catch (Exception ex)
                                                                                {
                                                                                    Log(string.Format("(1015): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                                    responseData.Append("Λάθος στην μετατροπή από " + row[6].ToString() + " λόγω του ποσού:" + oSPListItem["Ποσό Παραστατικού"].ToString() + "<br>");
                                                                                    filevalidated = false;
                                                                                    break;
                                                                                }
                                                                            }

                                                                            if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] != null)
                                                                            {
                                                                                //FYI: 20151209
                                                                                sumineuro += decimal.Parse(oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString());
                                                                                //sumineuro += this.ToDecimal(oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), noLines);
                                                                                //Log(string.Format("(1014) line: {0}, Ισότιμο σε ΕΥΡΩ:{1}, sumineuro:{2}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString(), sumineuro));
                                                                            }

                                                                            oSPListItem["Είδος Παραστατικού"] = row[7].ToString();
                                                                            oSPListItem["Αριθμός Παραστατικού"] = row[8].ToString();

                                                                            string dummydate2 = "";
                                                                            int length = 0;
                                                                            int pos1 = 0;
                                                                            int pos2 = 0;
                                                                            string dummydate = "";

                                                                            DateTime dummydate3;

                                                                            if (DateTime.TryParse(row[9].ToString(), out dummydate3))
                                                                            {
                                                                                oSPListItem["Ημερομηνία Παραστατικού"] = dummydate3;
                                                                            }
                                                                            else
                                                                            {
                                                                                try
                                                                                {
                                                                                    dummydate2 = row[9].ToString();
                                                                                    length = dummydate2.Length;
                                                                                    pos1 = dummydate2.IndexOf("/");
                                                                                    pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                    dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                    oSPListItem["Ημερομηνία Παραστατικού"] = dummydate;
                                                                                }
                                                                                catch
                                                                                {

                                                                                    if (row[7].ToString().Equals("Τιμολόγιο"))
                                                                                    {
                                                                                        responseData.Append("Κρίσιμο Λάθος στην Ημερομηνία Παραστατικού :" + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                        filevalidated = false;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        responseData.Append("η Ημερομηνία Παραστατικού :" + dummydate + " είναι λάθος στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                    }
                                                                                }
                                                                            }


                                                                            oSPListItem["Κατηγορία Προϊόντος"] = row[10].ToString();
                                                                            oSPListItem["Είδος Προϊόντος"] = row[11].ToString();
                                                                            if (DateTime.TryParse(row[12].ToString(), out dummydate3))
                                                                            {
                                                                                oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate3;
                                                                            }
                                                                            else
                                                                            {
                                                                                try
                                                                                {
                                                                                    dummydate2 = row[12].ToString();
                                                                                    length = dummydate2.Length;
                                                                                    pos1 = dummydate2.IndexOf("/");
                                                                                    pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                    dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                    oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate;
                                                                                }
                                                                                catch
                                                                                {
                                                                                    responseData.Append("Λάθος στην Ημερομηνία Λήξης Τιμολογίου :" + dummydate + " στην γραμμή " + noLines + "<br>");
                                                                                }
                                                                            }
                                                                            oSPListItem["Όρος Πληρωμής"] = row[13].ToString().ToUpper();
                                                                            oSPListItem["Σχόλια Πληρωμής"] = row[14].ToString();
                                                                            if (DateTime.TryParse(row[15].ToString(), out dummydate3))
                                                                            {
                                                                                oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate3;
                                                                            }
                                                                            else
                                                                            {
                                                                                try
                                                                                {
                                                                                    dummydate2 = row[15].ToString();
                                                                                    length = dummydate2.Length;
                                                                                    pos1 = dummydate2.IndexOf("/");
                                                                                    pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                    dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);
                                                                                    oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate;
                                                                                }
                                                                                catch
                                                                                {
                                                                                    if (row[7].ToString().Equals("Τιμολόγιο"))
                                                                                    {
                                                                                        responseData.Append("Λάθος στην Ημερομηνία Παράδοσης Προϊόντος: " + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                        filevalidated = false;
                                                                                        break;
                                                                                    }
                                                                                }
                                                                            }


                                                                            try
                                                                            {
                                                                                oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"] = Math.Round(decimal.Parse(row[17].ToString()), 2);
                                                                            }
                                                                            catch
                                                                            {
                                                                                responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }
                                                                            if (decimal.Parse(oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"].ToString()) < 0)
                                                                            {
                                                                                responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }

                                                                            try
                                                                            {
                                                                                oSPListItem["Συνολική Ετήσια Αξία"] = Math.Round(decimal.Parse(row[18].ToString()), 2);
                                                                            }
                                                                            catch
                                                                            {
                                                                                responseData.Append("Λάθος στήν Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                            }

                                                                            if (decimal.Parse(oSPListItem["Συνολική Ετήσια Αξία"].ToString()) < 0)
                                                                            {
                                                                                responseData.Append("Λάθος στήν Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }

                                                                            try
                                                                            {
                                                                                oSPListItem["Όριο"] = Math.Round(decimal.Parse(row[17].ToString()) * 140 / 100); //FYI: AG request
                                                                            }
                                                                            catch
                                                                            {
                                                                                responseData.Append("Λάθος στο Μηνιαίο Όριο ΠΝΠ :" + row[17].ToString() + "<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }

                                                                            if (decimal.Parse(oSPListItem["Συνολική Ετήσια Αξία"].ToString()) <
                                                                                decimal.Parse((oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"].ToString())))
                                                                            {
                                                                                responseData.Append("Λάθος: η Συνολική Ετήσια Αξία (" + row[18].ToString() + ") είναι μικρότερη από την Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό (" + row[17].ToString() + ")<br>");
                                                                                filevalidated = false;
                                                                                break;
                                                                            }

                                                                            katastimaurl = webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                            //katastimaurl4source = HttpUtility.UrlEncode(katastimaurl); //webapp + "/" + oList.RootFolder.Url.ToString();
                                                                            if (katastimaurl.Length < 255)
                                                                            {
                                                                                katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                            }
                                                                            else
                                                                            {
                                                                                string katastimaurlsmall = oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                if (katastimaurlsmall.Length < 255)
                                                                                {
                                                                                    katastimaurl4source = HttpUtility.UrlEncode(katastimaurlsmall);
                                                                                }
                                                                                else
                                                                                {
                                                                                    katastimaurl4source = "/";
                                                                                }
                                                                            }
                                                                            katastimaurl2 = "Κατάστημα: <a href='" + webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString() + "?Source=" + katastimaurl4source + "' target=_blank >" + dd_katastimata.SelectedValue.ToString() + "</a><br>";
                                                                            //responseData.Append("εγγραφή: <a href='" + webapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + "<br>");
                                                                            //responseData.Append("εγγραφή: <a href='" + webapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + "<br>");
                                                                            //responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + " στην γραμμή "+noLines+" είναι σωστή!<br>");
                                                                            if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                            {
                                                                                responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                            }
                                                                            else
                                                                            {
                                                                                if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                                }
                                                                                else
                                                                                {
                                                                                    responseData.Append("η εγγραφή: " + kodikosaitimatos + " με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " στην γραμμή " + noLines + " είναι σωστή!<br>");
                                                                                }
                                                                            }
                                                                            #endregion
                                                                        }
                                                                        else
                                                                        {
                                                                            #region currency or entoleas is not ok
                                                                            if (!row[6].ToString().ToUpper().Equals(currency))
                                                                            {
                                                                                responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετικό νόμισμα!<br>");
                                                                            }
                                                                            if (!row[0].ToString().ToUpper().Equals(entoleas))
                                                                            {
                                                                                responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετικός εντολέας!<br>");
                                                                            }
                                                                            if (!row[3].ToString().ToUpper().Equals(dikaiouxos))
                                                                            {
                                                                                responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετικός δικαιούχος!<br>");
                                                                            }
                                                                            if (!row[17].ToString().ToUpper().Equals(megisti))
                                                                            {
                                                                                responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετική Μέγιστη Μηνιαία Αξία Μεταφορών!<br>");
                                                                            }
                                                                            if (!row[18].ToString().ToUpper().Equals(sinoliki))
                                                                            {
                                                                                responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετική Συνολική Αξία Προηγούμενου Έτους!<br>");
                                                                            }
                                                                            responseData.Append("η γραμμή " + noLines + " εχει λάθη");
                                                                            filevalidated = false;
                                                                            break;
                                                                            #endregion
                                                                        }
                                                                    }



                                                                }//END TRY
                                                                catch (Exception ex)
                                                                {
                                                                    Log(string.Format("(1241): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                                                    responseData.Append("test:" + ex.ToString() + "<br>");
                                                                    filevalidated = false;
                                                                    break;
                                                                }
                                                                #endregion
                                                            }//end else
                                                        }// end if sunolo
                                                    }//end oWeb
                                                }//end oSite
                                                #endregion
                                            }// end if columns
                                            else
                                            {
                                                responseData.Append("Λάθος Πεδία (" + dtCSV.Columns.Count.ToString() + ") στην γραμμή : " + noLines + "<br>");
                                                filevalidated = false;
                                                break;
                                            }//end else columns
                                            #endregion
                                        }//end for each data row

                                        //Log(string.Format("(1260)noLines:{0}, sum:{1}, sumineuro:{2}, currency:{3}", noLines, sum, sumineuro, currency));
                                        Log("mySumToEuro: " + mySumToEuro);
                                        lbMySumToEuro.Text = "mySumToEuro: " + mySumToEuro;

                                        //------------>if (sum < 0)
                                        if (mySumToEuro < 0)
                                        {
                                            responseData.Append("<font color='red'>Το τελικό σύνολο είναι αρνητικό: " + mySumToEuro + " </font><br>");
                                            filevalidated = false;
                                        }
                                        else
                                        {
                                            //FYI: changes -- 20151204
                                            //decimal rateSum = Math.Round(sum / GetCurrentRate(currency), 2);
                                            //Log(string.Format("(1271)noLines:{0}, sum:{1}, sumineuro:{2}, currency:{3}", noLines, sum, sumineuro, currency));
                                            //Log("mySumToEuro > 350000: " + (mySumToEuro > dailyLimit));
                                            //Log("noLines > 50: " + (noLines > 50));

                                            if (mySumToEuro > dailyLimit || (noLines > 50)) //FYI: issue 280
                                            //-------------->if (sumineuro > 150000 || (noLines > 50))
                                            {
                                                //responseData.Append("<font color='red'>Το τελικό σύνολο είναι πάνω από 150.000: " + sum + " </font><br>");
                                                responseData.Append("<font color='red'>Το τελικό σύνολο είναι πάνω από 350.000 </font><br>");  //FYI: changes -- 20151204
                                                responseData.Append("<font color='red'>ή οι γραμμές είναι πάνω από 50: " + noLines + " </font><br>");
                                                #region over 50

                                                if (filevalidated)
                                                {
                                                    #region file validated

                                                    //Log(string.Format("(1285 Ολοκληρώθηκε η εισαγωγή ...)noLines:{0}, sum:{1}, sumineuro:{2}, currency:{3}", noLines, sum, sumineuro, currency));
                                                    //Log(string.Format("Ολοκληρώθηκε η εισαγωγή των παρακάτω εγγραφών με Τελικό Σύνολο: " + sum.ToString() + " " + currency));

                                                    noLines = 0;
                                                    responseData.Append("Ολοκληρώθηκε η εισαγωγή των παρακάτω εγγραφών με Τελικό Σύνολο: " + sum.ToString() + " " + currency + "<br>");
                                                    if (!currency.Equals("EUR") && sumineuro > 0)
                                                    {
                                                        responseData.Append("και Τελικό Σύνολο σε ευρώ: " + sumineuro.ToString() + "<br>");
                                                        //responseData.Append("και Τελικό Σύνολο σε ευρώ: " + rateSum.ToString() + "<br>"); //FYI: changes -- 20151204
                                                    }
                                                    foreach (DataRow row in dtCSV.Rows)
                                                    {
                                                        //FYI: changes -- 20151209
                                                        if (AreAllValidColumnsEmpty(row) || !FirstColumnHasValue(row))
                                                            continue;

                                                        //FYI: changes -- 20151203
                                                        if (FirstColumnHasValue(row))
                                                        {
                                                            noLines++;
                                                        }

                                                        if (dtCSV.Columns.Count == 19)
                                                        {
                                                            #region columns is ok
                                                            using (SPSite oSite = new SPSite(webapp))
                                                            {
                                                                using (SPWeb oWeb = oSite.RootWeb)
                                                                {
                                                                    SPList oList = oWeb.Lists["TODO"];
                                                                    if (!row[16].ToString().Contains("Σύνολο:") && row[1].ToString().Length != 0)
                                                                    {
                                                                        #region sinolo
                                                                        if (!afm.Text.Equals(row[1].ToString()) && row[1].ToString().Length != 0)
                                                                        {
                                                                            #region missmatch afm
                                                                            responseData.Append("στην γραμμή :" + noLines + " υπάρχει λάθος ΑΦΜ <br>");
                                                                            foreach (int itmID in addedIDs)
                                                                            {
                                                                                SPListItem tobeDeleted = oList.GetItemById(itmID);
                                                                                tobeDeleted.Delete();
                                                                                responseData.Append("εγγραφή με id " + itmID.ToString() + " διαγράφηκε λόγω διαφορετικων ΑΦΜ στο ίδιο αρχείο!<br>");
                                                                            }
                                                                            break;
                                                                            #endregion
                                                                        }//end if afm 
                                                                        else
                                                                        {
                                                                            #region else actual add items
                                                                            try
                                                                            {
                                                                                SPListItem oSPListItem;

                                                                                if (IsTestEnvironment(webapp)) //if (webapp.Equals("http://TODO2013:81"))
                                                                                {
                                                                                    oSPListItem = oList.AddItem("/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                                }
                                                                                else
                                                                                {
                                                                                    oSPListItem = oList.AddItem("/TODO/pnpdemands/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                                }


                                                                                String kodikosaitimatos = "";
                                                                                if (noLines < 2)
                                                                                {
                                                                                    #region actual add first and only item

                                                                                    currency = row[6].ToString().ToUpper();
                                                                                    entoleas = row[0].ToString();
                                                                                    dikaiouxos = row[3].ToString().ToUpper();
                                                                                    kodikosaitimatos = DateTime.Now.ToString("yyyyMMdd") + "-" +
                                                                                    dd_katastimata.SelectedValue.ToString().Substring(0, 3) + "-" +
                                                                                    afm.Text + "-" +
                                                                                    cdpel.Text + "-" +
                                                                                    row[6].ToString().ToUpper() + "-" +
                                                                                    dd_group.SelectedValue.ToString();
                                                                                    oSPListItem["Κωδικός Αιτήματος"] = kodikosaitimatos;
                                                                                    oSPListItem["CDI Πελάτη"] = cdpel.Text;
                                                                                    oSPListItem["Κωδικός Καταστήματος"] = dd_katastimata.SelectedValue.ToString();
                                                                                    oSPListItem["Group"] = dd_group.SelectedValue.ToString();
                                                                                    oSPListItem["Είδος Εντολέα"] = dd_entoleas.SelectedValue.ToString();
                                                                                    oSPListItem["Μονάδα Διαχείρισης"] = dd_md.SelectedValue.ToString();
                                                                                    oSPListItem["Ημερομηνία υποβολής αιτήματος από τον Πελάτη"] = datepel.SelectedDate.ToString("yyyy-MM-dd");
                                                                                    oSPListItem["Title"] = "Αίτημα Συναλλαγής";
                                                                                    oSPListItem["Πελάτης/Εντολέας"] = row[0].ToString();
                                                                                    oSPListItem["ΑΦΜ"] = row[1].ToString();
                                                                                    oSPListItem["Είδος Συναλλαγής"] = row[2].ToString();
                                                                                    oSPListItem["Δικαιούχος Εντολής"] = row[3].ToString();
                                                                                    oSPListItem["Χώρα Προορισμού Κεφαλαίων"] = row[4].ToString();
                                                                                    oSPListItem["Αιτιολογία Συναλλαγής"] = row[5].ToString();
                                                                                    oSPListItem["Νόμισμα"] = row[6].ToString().ToUpper();
                                                                                    oSPListItem["Προς Καταχώρηση από Κ/Υ"] = ddKY.SelectedValue; //FYI:20160217

                                                                                    try
                                                                                    {
                                                                                        //Log(string.Format("(1377) line: {0}, Sum σε Ποσό Παραστατικού: {1}", noLines, sum));
                                                                                        //FYI: 20151209
                                                                                        // ---> oSPListItem["Ποσό Παραστατικού"] = sum;
                                                                                        oSPListItem["Ποσό Παραστατικού"] = Math.Round(sum, 2);
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Ποσό Παραστατικού :" + row[16].ToString() + "<br>"); // add first line
                                                                                    }


                                                                                    if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            //FYI: 20151209
                                                                                            oSPListItem["Ισότιμο σε ΕΥΡΩ"] = oSPListItem["Ποσό Παραστατικού"];
                                                                                            //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);
                                                                                            //Log(string.Format("(1395) line:{0}, Ισότιμο σε ΕΥΡΩ: {1}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString()));
                                                                                        }
                                                                                        catch (Exception ex)
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Ισότιμο σε ΕΥΡΩ :" + ex.ToString() + "<br>");
                                                                                        }


                                                                                    }//edn if eur
                                                                                    else
                                                                                    {
                                                                                        oSPListItem["Ισότιμο σε ΕΥΡΩ"] = sumineuro;
                                                                                    }

                                                                                    oSPListItem["Είδος Παραστατικού"] = "Μαζικό";
                                                                                    oSPListItem["Αριθμός Παραστατικού"] = "99999";

                                                                                    string dummydate2 = "";
                                                                                    int length = 0;
                                                                                    int pos1 = 0;
                                                                                    int pos2 = 0;
                                                                                    string dummydate = "";

                                                                                    DateTime dummydate3;

                                                                                    if (DateTime.TryParse(row[9].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Παραστατικού"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[9].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                            oSPListItem["Ημερομηνία Παραστατικού"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στην Ημερομηνία Παραστατικού :" + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                            filevalidated = false;

                                                                                        }
                                                                                    }


                                                                                    oSPListItem["Κατηγορία Προϊόντος"] = row[10].ToString();
                                                                                    oSPListItem["Είδος Προϊόντος"] = row[11].ToString();
                                                                                    if (DateTime.TryParse(row[12].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[12].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                            oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στην Ημερομηνία Λήξης Τιμολογίου :" + dummydate + "<br>");
                                                                                        }
                                                                                    }
                                                                                    oSPListItem["Όρος Πληρωμής"] = row[13].ToString().ToUpper();
                                                                                    oSPListItem["Σχόλια Πληρωμής"] = row[14].ToString();
                                                                                    if (DateTime.TryParse(row[15].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[15].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);
                                                                                            oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            if (row[7].ToString().Equals("Τιμολόγιο"))
                                                                                            {
                                                                                                responseData.Append("Λάθος στην Ημερομηνία Παράδοσης Προϊόντος: " + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                                filevalidated = false;
                                                                                                break;
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"] = Math.Round(decimal.Parse(row[17].ToString()), 2);
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό: " + row[17].ToString() + "<br>");
                                                                                    }


                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Συνολική Ετήσια Αξία"] = Math.Round(decimal.Parse(row[18].ToString()), 2);
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                                    }

                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Όριο"] = Math.Round(decimal.Parse(row[17].ToString()) * 140 / 100, 2); //FYI: AG request
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Μηνιαίο Όριο ΠΝΠ :" + row[17].ToString() + "<br>");
                                                                                    }

                                                                                    #region add additional files
                                                                                    if (FileUpload1.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname1 = "maziko.xlsx";// +Path.GetFileName(FileUpload1.PostedFile.FileName.ToString());
                                                                                        byte[] textfile1 = FileUpload1.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname1, textfile1);
                                                                                    }

                                                                                    if (FileUpload2.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname2 = "Αίτηση_" + Path.GetFileName(FileUpload2.PostedFile.FileName.ToString());
                                                                                        byte[] textfile2 = FileUpload2.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname2, textfile2);
                                                                                    }

                                                                                    if (FileUpload3.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname3 = "Δήλωση_" + Path.GetFileName(FileUpload3.PostedFile.FileName.ToString());
                                                                                        byte[] textfile3 = FileUpload3.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname3, textfile3);
                                                                                    }

                                                                                    if (FileUpload4.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname4 = "Τιμ_" + Path.GetFileName(FileUpload4.PostedFile.FileName.ToString());
                                                                                        byte[] textfile4 = FileUpload4.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname4, textfile4);
                                                                                    }
                                                                                    #endregion
                                                                                    oWeb.AllowUnsafeUpdates = true;
                                                                                    oSPListItem.Update();
                                                                                    oWeb.AllowUnsafeUpdates = false;
                                                                                    addedIDs.Add(oSPListItem.ID);
                                                                                    katastimaurl = webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();

                                                                                    if (katastimaurl.Length < 255)
                                                                                    {
                                                                                        katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        string katastimaurlsmall = oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                        if (katastimaurlsmall.Length < 255)
                                                                                        {
                                                                                            katastimaurl4source = HttpUtility.UrlEncode(katastimaurlsmall);
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            katastimaurl4source = "/";
                                                                                        }
                                                                                    }
                                                                                    katastimaurl2 = "Κατάστημα: <a href='" + webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString() + "?Source=" + katastimaurl4source + "' target=_blank >" + dd_katastimata.SelectedValue.ToString() + "</a><br>";
                                                                                    string newwebapp = webapp;
                                                                                    if (webapp.IndexOf("TODO") > 0)
                                                                                    {
                                                                                        newwebapp = webapp.Substring(0, webapp.IndexOf("TODO"));
                                                                                    }
                                                                                    if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                    {
                                                                                        responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                        {
                                                                                            responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " καταχωρήθηκε!<br>");
                                                                                        }
                                                                                    }
                                                                                    #endregion
                                                                                }


                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                responseData.Append("test2" + ex.ToString() + "<br>");
                                                                            }
                                                                            #endregion
                                                                        }// end else if afm
                                                                        #endregion
                                                                    }// end if Σύνολο
                                                                }//end using oweb
                                                            }//end using osite

                                                            #endregion
                                                        }//dtCSV.Columns.Count == 19
                                                        else
                                                        {
                                                            responseData.Append("Λάθος Πεδία (" + dtCSV.Columns.Count.ToString() + ") στην γραμμή : " + noLines + "<br>");
                                                        }//end else columns
                                                    } //end for each datarow
                                                    #endregion
                                                }
                                                else
                                                {
                                                    responseData.Append("<font color='red'>Το αρχείο έχει λάθη και δεν μπορεί να εισαχθεί!</font>");
                                                }
                                                #endregion
                                            }
                                            else
                                            {

                                                if (filevalidated)
                                                {
                                                    #region file validated
                                                    //Log(string.Format("(1636)noLines:{0}, sum:{1}, sumineuro:{2}, currency:{3}", noLines, sum, sumineuro, currency));
                                                    //Log(string.Format("Ολοκληρώθηκε η εισαγωγή των παρακάτω εγγραφών με Τελικό Σύνολο: " + sum.ToString() + " " + currency));

                                                    noLines = 0;
                                                    responseData.Append("Ολοκληρώθηκε η εισαγωγή των παρακάτω εγγραφών με Τελικό Σύνολο: " + sum.ToString() + " " + currency + "<br>");
                                                    if (!currency.Equals("EUR") && sumineuro > 0)
                                                    {
                                                        responseData.Append("και Τελικό Σύνολο σε ευρώ: " + sumineuro.ToString() + "<br>");
                                                        //Log(string.Format("και Τελικό Σύνολο σε ευρώ: " + sumineuro.ToString()));
                                                    }
                                                    foreach (DataRow row in dtCSV.Rows)
                                                    {
                                                        //FYI: changes -- 20151203
                                                        if (FirstColumnHasValue(row))
                                                        {
                                                            noLines++;
                                                        }

                                                        if (dtCSV.Columns.Count == 19)
                                                        {
                                                            #region columns is ok
                                                            using (SPSite oSite = new SPSite(webapp))
                                                            {
                                                                using (SPWeb oWeb = oSite.RootWeb)
                                                                {
                                                                    SPList oList = oWeb.Lists["TODO"];
                                                                    if (!row[16].ToString().Contains("Σύνολο:") && row[1].ToString().Length != 0)
                                                                    {
                                                                        #region sinolo
                                                                        if (!afm.Text.Equals(row[1].ToString()) && row[1].ToString().Length != 0)
                                                                        {
                                                                            #region missmatch afm
                                                                            responseData.Append("στην γραμμή :" + noLines + " υπάρχει λάθος ΑΦΜ <br>");
                                                                            foreach (int itmID in addedIDs)
                                                                            {
                                                                                SPListItem tobeDeleted = oList.GetItemById(itmID);
                                                                                tobeDeleted.Delete();
                                                                                responseData.Append("εγγραφή με id " + itmID.ToString() + " διαγράφηκε λόγω διαφορετικων ΑΦΜ στο ίδιο αρχείο!<br>");
                                                                            }
                                                                            break;
                                                                            #endregion
                                                                        }//end if afm 
                                                                        else
                                                                        {
                                                                            #region else actual add items
                                                                            try
                                                                            {
                                                                                //SPListItem oSPListItem = oList.Items.Add("/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                                //SPListItem oSPListItem = oList.Items.Add();
                                                                                SPListItem oSPListItem;
                                                                                
                                                                                if (IsTestEnvironment(webapp)) //if (webapp.Equals("http://TODO2013:81"))
                                                                                {
                                                                                    oSPListItem = oList.AddItem("/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                                }
                                                                                else
                                                                                {
                                                                                    oSPListItem = oList.AddItem("/TODO/pnpdemands/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString(), SPFileSystemObjectType.File, null);
                                                                                }
                                                                                //SPListItem oSPListItem = oList.AddItem();
                                                                                //responseData.Append("<br>/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString());
                                                                                //responseData.Append("<br>/TODO/pnpdemands/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString());


                                                                                String kodikosaitimatos = "";
                                                                                //string fakelos = "CreationDate-BranchCode-AFM-CDI-Currency-Group";
                                                                                //20150910-105-094008102-0000609155-EUR-01
                                                                                if (noLines < 2)
                                                                                {
                                                                                    //Log(string.Format("(1630)noLines: {0}", noLines));

                                                                                    #region actual add first item
                                                                                    //g = Guid.NewGuid();
                                                                                    //string GuidString = Convert.ToBase64String(g.ToByteArray());
                                                                                    //GuidString = GuidString.Replace("=", "");
                                                                                    //GuidString = GuidString.Replace("+", "");
                                                                                    currency = row[6].ToString().ToUpper();
                                                                                    entoleas = row[0].ToString();
                                                                                    dikaiouxos = row[3].ToString().ToUpper();
                                                                                    kodikosaitimatos = DateTime.Now.ToString("yyyyMMdd") + "-" +
                                                                                    dd_katastimata.SelectedValue.ToString().Substring(0, 3) + "-" +
                                                                                    afm.Text + "-" +
                                                                                    cdpel.Text + "-" +
                                                                                    row[6].ToString().ToUpper() + "-" +
                                                                                    dd_group.SelectedValue.ToString();
                                                                                    oSPListItem["Κωδικός Αιτήματος"] = kodikosaitimatos;
                                                                                    oSPListItem["CDI Πελάτη"] = cdpel.Text;
                                                                                    oSPListItem["Κωδικός Καταστήματος"] = dd_katastimata.SelectedValue.ToString();
                                                                                    oSPListItem["Group"] = dd_group.SelectedValue.ToString();
                                                                                    oSPListItem["Είδος Εντολέα"] = dd_entoleas.SelectedValue.ToString();
                                                                                    oSPListItem["Μονάδα Διαχείρισης"] = dd_md.SelectedValue.ToString();
                                                                                    oSPListItem["Ημερομηνία υποβολής αιτήματος από τον Πελάτη"] = datepel.SelectedDate.ToString("yyyy-MM-dd");
                                                                                    oSPListItem["Title"] = "Αίτημα Συναλλαγής";
                                                                                    oSPListItem["Πελάτης/Εντολέας"] = row[0].ToString();
                                                                                    oSPListItem["ΑΦΜ"] = row[1].ToString();
                                                                                    oSPListItem["Είδος Συναλλαγής"] = row[2].ToString();
                                                                                    oSPListItem["Δικαιούχος Εντολής"] = row[3].ToString();
                                                                                    oSPListItem["Χώρα Προορισμού Κεφαλαίων"] = row[4].ToString();
                                                                                    oSPListItem["Αιτιολογία Συναλλαγής"] = row[5].ToString();
                                                                                    oSPListItem["Νόμισμα"] = row[6].ToString().ToUpper();
                                                                                    oSPListItem["Προς Καταχώρηση από Κ/Υ"] = ddKY.SelectedValue; //FYI:20160217

                                                                                    try
                                                                                    {
                                                                                        #region old Ποσό Παραστατικού

                                                                                        if (row[16].ToString().Length > 2)
                                                                                        {
                                                                                            if (row[16].ToString().Substring(row[16].ToString().Length - 3, 1).Equals("."))
                                                                                            {
                                                                                                oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                                //Log(string.Format("(1741) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals(","))
                                                                                                {
                                                                                                    oSPListItem["Ποσό Παραστατικού"] = row[16].ToString().Replace(",", ".") + "0";
                                                                                                    //Log(string.Format("(1748) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals("."))
                                                                                                    {
                                                                                                        oSPListItem["Ποσό Παραστατικού"] = row[16].ToString() + "0";
                                                                                                        //Log(string.Format("(1755) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        oSPListItem["Ποσό Παραστατικού"] = Math.Round(decimal.Parse(row[16].ToString()), 2);
                                                                                                        //Log(string.Format("(1760) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                            //Log(string.Format("(1768) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                        }

                                                                                        #endregion

                                                                                        //oSPListItem["Ποσό Παραστατικού"] = this.ToDecimal(row[16].ToString(), noLines);

                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Ποσό Παραστατικού :" + row[16].ToString() + "<br>"); // add first line
                                                                                    }


                                                                                    if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            //FYI: 20151209
                                                                                            oSPListItem["Ισότιμο σε ΕΥΡΩ"] = oSPListItem["Ποσό Παραστατικού"];
                                                                                            //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);
                                                                                            //Log(string.Format("(1789) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                        }
                                                                                        catch (Exception ex)
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Ισότιμο σε ΕΥΡΩ :" + ex.ToString() + "<br>");
                                                                                        }


                                                                                    }//edn if eur
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            SPList rates = oWeb.Lists["Rates"];
                                                                                            SPQuery oQuery = new SPQuery();
                                                                                            oQuery.Query = "<Where><And><Eq><FieldRef Name='Title'/>" +
                                                                                                "<Value Type='Text'>" + row[6].ToString() + "</Value></Eq>" +
                                                                                                "<Eq><FieldRef Name='RateDate'/><Value Type='DateTime'>" + DateTime.Now.ToString("yyyy-MM-dd") + "</Value></Eq></And></Where>";
                                                                                            SPListItemCollection collListItems = rates.GetItems(oQuery);

                                                                                            foreach (SPListItem oListItem in collListItems)
                                                                                            {
                                                                                                if (oListItem["RateMTF"].ToString() != null)
                                                                                                {
                                                                                                    if (decimal.Parse(oListItem["RateMTF"].ToString()) > 0)
                                                                                                    {
                                                                                                        //FYI: 20151209
                                                                                                        oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString()) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                        //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                        //Log(string.Format("(1818) line: {0}, Ισότιμο σε ΕΥΡΩ: {1}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString()));

                                                                                                        oSPListItem["rate"] = oListItem["RateMTF"];
                                                                                                        oSPListItem["ratedate"] = DateTime.Parse(oListItem["RateDate"].ToString()).ToString("dd/MM/yyyy");
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στην μετατροπή από " + row[6].ToString() + " λόγω του ποσού:" + oSPListItem["Ποσό Παραστατικού"].ToString() + "<br>");
                                                                                            filevalidated = false;
                                                                                            break;
                                                                                        }
                                                                                    }

                                                                                    oSPListItem["Είδος Παραστατικού"] = row[7].ToString();
                                                                                    oSPListItem["Αριθμός Παραστατικού"] = row[8].ToString();

                                                                                    string dummydate2 = "";
                                                                                    int length = 0;
                                                                                    int pos1 = 0;
                                                                                    int pos2 = 0;
                                                                                    string dummydate = "";

                                                                                    DateTime dummydate3;

                                                                                    if (DateTime.TryParse(row[9].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Παραστατικού"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[9].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                            oSPListItem["Ημερομηνία Παραστατικού"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στην Ημερομηνία Παραστατικού :" + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                            filevalidated = false;

                                                                                        }
                                                                                    }


                                                                                    oSPListItem["Κατηγορία Προϊόντος"] = row[10].ToString();
                                                                                    oSPListItem["Είδος Προϊόντος"] = row[11].ToString();
                                                                                    if (DateTime.TryParse(row[12].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[12].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                            oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στην Ημερομηνία Λήξης Τιμολογίου :" + dummydate + "<br>");
                                                                                        }
                                                                                    }
                                                                                    oSPListItem["Όρος Πληρωμής"] = row[13].ToString().ToUpper();
                                                                                    oSPListItem["Σχόλια Πληρωμής"] = row[14].ToString();
                                                                                    if (DateTime.TryParse(row[15].ToString(), out dummydate3))
                                                                                    {
                                                                                        oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate3;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        try
                                                                                        {
                                                                                            dummydate2 = row[15].ToString();
                                                                                            length = dummydate2.Length;
                                                                                            pos1 = dummydate2.IndexOf("/");
                                                                                            pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                            dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);
                                                                                            oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate;
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            if (row[7].ToString().Equals("Τιμολόγιο"))
                                                                                            {
                                                                                                responseData.Append("Λάθος στην Ημερομηνία Παράδοσης Προϊόντος: " + dummydate + " στην γραμμή " + noLines + " λόγω Τιμολογίου<br>");
                                                                                                filevalidated = false;
                                                                                                break;
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"] = Math.Round(decimal.Parse(row[17].ToString()), 2);
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό: " + row[17].ToString() + "<br>");
                                                                                    }


                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Συνολική Ετήσια Αξία"] = Math.Round(decimal.Parse(row[18].ToString()), 2);
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                                    }

                                                                                    try
                                                                                    {
                                                                                        oSPListItem["Όριο"] = Math.Round(decimal.Parse(row[17].ToString()) * 140 / 100, 2); //FYI: AG request
                                                                                    }
                                                                                    catch
                                                                                    {
                                                                                        responseData.Append("Λάθος στο Μηνιαίο Όριο ΠΝΠ :" + row[17].ToString() + "<br>");
                                                                                    }

                                                                                    #region add additional files
                                                                                    if (FileUpload2.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname2 = "Αίτηση_" + Path.GetFileName(FileUpload2.PostedFile.FileName.ToString());
                                                                                        byte[] textfile2 = FileUpload2.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname2, textfile2);
                                                                                    }

                                                                                    if (FileUpload3.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname3 = "Δήλωση_" + Path.GetFileName(FileUpload3.PostedFile.FileName.ToString());
                                                                                        byte[] textfile3 = FileUpload3.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname3, textfile3);
                                                                                    }

                                                                                    if (FileUpload4.HasFile == true && noLines < 2)
                                                                                    {
                                                                                        string fname4 = "Τιμ_" + Path.GetFileName(FileUpload4.PostedFile.FileName.ToString());
                                                                                        byte[] textfile4 = FileUpload4.FileBytes;
                                                                                        oSPListItem.Attachments.Add(fname4, textfile4);
                                                                                    }
                                                                                    #endregion
                                                                                    oWeb.AllowUnsafeUpdates = true;
                                                                                    oSPListItem.Update();
                                                                                    oWeb.AllowUnsafeUpdates = false;
                                                                                    addedIDs.Add(oSPListItem.ID);
                                                                                    katastimaurl = webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                    //katastimaurl4source = webapp + "/" + oList.RootFolder.Url.ToString();
                                                                                    //katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                                    if (katastimaurl.Length < 255)
                                                                                    {
                                                                                        katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        string katastimaurlsmall = oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                        if (katastimaurlsmall.Length < 255)
                                                                                        {
                                                                                            katastimaurl4source = HttpUtility.UrlEncode(katastimaurlsmall);
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            katastimaurl4source = "/";
                                                                                        }
                                                                                    }
                                                                                    katastimaurl2 = "Κατάστημα: <a href='" + webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString() + "?Source=" + katastimaurl4source + "' target=_blank >" + dd_katastimata.SelectedValue.ToString() + "</a><br>";
                                                                                    string newwebapp = webapp;
                                                                                    if (webapp.IndexOf("TODO") > 0)
                                                                                    {
                                                                                        newwebapp = webapp.Substring(0, webapp.IndexOf("TODO"));
                                                                                    }
                                                                                    //responseData.Append("<br>newwebapp1:" + newwebapp+"<br>");
                                                                                    //responseData.Append("εγγραφή: <a href='" + webapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + "<br>");
                                                                                    if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                    {
                                                                                        responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                        {
                                                                                            responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " καταχωρήθηκε!<br>");
                                                                                        }
                                                                                    }
                                                                                    #endregion
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (row[6].ToString().ToUpper().Equals(currency))
                                                                                    {
                                                                                        //Log(string.Format("(1935)currency: {0}", currency));

                                                                                        #region add additional items
                                                                                        kodikosaitimatos = DateTime.Now.ToString("yyyyMMdd") + "-" +
                                                                                        dd_katastimata.SelectedValue.ToString().Substring(0, 3) + "-" +
                                                                                        afm.Text + "-" +
                                                                                        cdpel.Text + "-" +
                                                                                        row[6].ToString().ToUpper() + "-" +
                                                                                        dd_group.SelectedValue.ToString();

                                                                                        oSPListItem["Κωδικός Αιτήματος"] = kodikosaitimatos;
                                                                                        oSPListItem["CDI Πελάτη"] = cdpel.Text;
                                                                                        oSPListItem["Κωδικός Καταστήματος"] = dd_katastimata.SelectedValue.ToString();
                                                                                        oSPListItem["Group"] = dd_group.SelectedValue.ToString();
                                                                                        oSPListItem["Είδος Εντολέα"] = dd_entoleas.SelectedValue.ToString();
                                                                                        oSPListItem["Μονάδα Διαχείρισης"] = dd_md.SelectedValue.ToString();
                                                                                        oSPListItem["Ημερομηνία υποβολής αιτήματος από τον Πελάτη"] = datepel.SelectedDate.ToString("yyyy-MM-dd");
                                                                                        oSPListItem["Title"] = "Αίτημα Συναλλαγής";
                                                                                        oSPListItem["Πελάτης/Εντολέας"] = row[0].ToString();
                                                                                        oSPListItem["ΑΦΜ"] = row[1].ToString();
                                                                                        oSPListItem["Είδος Συναλλαγής"] = row[2].ToString();
                                                                                        oSPListItem["Δικαιούχος Εντολής"] = row[3].ToString();
                                                                                        oSPListItem["Χώρα Προορισμού Κεφαλαίων"] = row[4].ToString();
                                                                                        oSPListItem["Αιτιολογία Συναλλαγής"] = row[5].ToString();
                                                                                        oSPListItem["Νόμισμα"] = row[6].ToString().ToUpper();
                                                                                        oSPListItem["Προς Καταχώρηση από Κ/Υ"] = ddKY.SelectedValue; //FYI:20160217

                                                                                        try
                                                                                        {
                                                                                            #region old Ποσό Παραστατικού

                                                                                            if (row[16].ToString().Length > 2)
                                                                                            {
                                                                                                if (row[16].ToString().Substring(row[16].ToString().Length - 3, 1).Equals("."))
                                                                                                {
                                                                                                    oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                                    //Log(string.Format("(2060) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals(","))
                                                                                                    {
                                                                                                        oSPListItem["Ποσό Παραστατικού"] = row[16].ToString().Replace(",", ".") + "0";
                                                                                                        //Log(string.Format("(2068) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        if (row[16].ToString().Substring(row[16].ToString().Length - 2, 1).Equals("."))
                                                                                                        {
                                                                                                            oSPListItem["Ποσό Παραστατικού"] = row[16].ToString() + "0";
                                                                                                            //Log(string.Format("(2074) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                        }
                                                                                                        else
                                                                                                        {
                                                                                                            oSPListItem["Ποσό Παραστατικού"] = Math.Round(decimal.Parse(row[16].ToString()), 2);
                                                                                                            //Log(string.Format("(2080) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                oSPListItem["Ποσό Παραστατικού"] = row[16].ToString();
                                                                                                //Log(string.Format("(2088) line:{0}, Ποσό Παραστατικού: {1}", noLines, oSPListItem["Ποσό Παραστατικού"].ToString()));
                                                                                            }

                                                                                            #endregion

                                                                                            //oSPListItem["Ποσό Παραστατικού"] = this.ToDecimal(row[16].ToString(), noLines);
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Ποσό Παραστατικού :" + row[16].ToString() + "<br>"); // add additionls items
                                                                                        }

                                                                                        if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                        {
                                                                                            try
                                                                                            {
                                                                                                //FYI: 20151209
                                                                                                oSPListItem["Ισότιμο σε ΕΥΡΩ"] = oSPListItem["Ποσό Παραστατικού"];
                                                                                                //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines);
                                                                                                //Log(string.Format("(2107) line:{0}, Ισότιμο σε ΕΥΡΩ: {1}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString()));
                                                                                            }
                                                                                            catch
                                                                                            {
                                                                                                responseData.Append("Λάθος στο Ισότιμο σε ΕΥΡΩ :" + oSPListItem["Ποσό Παραστατικού"].ToString() + "<br>");
                                                                                            }


                                                                                        }//edn if eur
                                                                                        else
                                                                                        {
                                                                                            try
                                                                                            {
                                                                                                SPList rates = oWeb.Lists["Rates"];
                                                                                                SPQuery oQuery = new SPQuery();
                                                                                                oQuery.Query = "<Where><And><Eq><FieldRef Name='Title'/>" +
                                                                                                    "<Value Type='Text'>" + row[6].ToString() + "</Value></Eq>" +
                                                                                                    "<Eq><FieldRef Name='RateDate'/><Value Type='DateTime'>" + DateTime.Now.ToString("yyyy-MM-dd") + "</Value></Eq></And></Where>";
                                                                                                SPListItemCollection collListItems = rates.GetItems(oQuery);

                                                                                                foreach (SPListItem oListItem in collListItems)
                                                                                                {
                                                                                                    if (oListItem["RateMTF"].ToString() != null)
                                                                                                    {
                                                                                                        if (decimal.Parse(oListItem["RateMTF"].ToString()) > 0)
                                                                                                        {
                                                                                                            //FYI: 20151209
                                                                                                            oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(decimal.Parse(oSPListItem["Ποσό Παραστατικού"].ToString()) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                            //oSPListItem["Ισότιμο σε ΕΥΡΩ"] = Math.Round(this.ToDecimal(oSPListItem["Ποσό Παραστατικού"].ToString(), noLines) / decimal.Parse(oListItem["RateMTF"].ToString()), 2);
                                                                                                            //Log(string.Format("(2136) line:{0}, Ισότιμο σε ΕΥΡΩ: {1}", noLines, oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString()));

                                                                                                            oSPListItem["rate"] = oListItem["RateMTF"];
                                                                                                            oSPListItem["ratedate"] = DateTime.Parse(oListItem["RateDate"].ToString()).ToString("dd/MM/yyyy");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            catch
                                                                                            {
                                                                                                responseData.Append("Λάθος στην μετατροπή από " + row[6].ToString() + " λόγω του ποσού:" + row[16].ToString() + "<br>");
                                                                                                filevalidated = false;
                                                                                                break;
                                                                                            }
                                                                                        }

                                                                                        oSPListItem["Είδος Παραστατικού"] = row[7].ToString();
                                                                                        oSPListItem["Αριθμός Παραστατικού"] = row[8].ToString();

                                                                                        string dummydate2 = "";
                                                                                        int length = 0;
                                                                                        int pos1 = 0;
                                                                                        int pos2 = 0;
                                                                                        string dummydate = "";

                                                                                        DateTime dummydate3;

                                                                                        if (DateTime.TryParse(row[9].ToString(), out dummydate3))
                                                                                        {
                                                                                            oSPListItem["Ημερομηνία Παραστατικού"] = dummydate3;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            try
                                                                                            {
                                                                                                dummydate2 = row[9].ToString();
                                                                                                length = dummydate2.Length;
                                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                                oSPListItem["Ημερομηνία Παραστατικού"] = dummydate;
                                                                                            }
                                                                                            catch
                                                                                            {
                                                                                                //responseData.Append("Λάθος στο Ημερομηνία Παραστατικού :" + dummydate + "<br>");
                                                                                            }
                                                                                        }


                                                                                        oSPListItem["Κατηγορία Προϊόντος"] = row[10].ToString();
                                                                                        oSPListItem["Είδος Προϊόντος"] = row[11].ToString();
                                                                                        if (DateTime.TryParse(row[12].ToString(), out dummydate3))
                                                                                        {
                                                                                            oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate3;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            try
                                                                                            {
                                                                                                dummydate2 = row[12].ToString();
                                                                                                length = dummydate2.Length;
                                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);


                                                                                                oSPListItem["Ημερομηνία Λήξης Τιμολογίου"] = dummydate;
                                                                                            }
                                                                                            catch
                                                                                            {
                                                                                                //responseData.Append("Λάθος στο Ημερομηνία Λήξης Τιμολογίου :" + dummydate + "<br>");
                                                                                            }
                                                                                        }
                                                                                        oSPListItem["Όρος Πληρωμής"] = row[13].ToString().ToUpper();
                                                                                        oSPListItem["Σχόλια Πληρωμής"] = row[14].ToString();
                                                                                        if (DateTime.TryParse(row[15].ToString(), out dummydate3))
                                                                                        {
                                                                                            oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate3;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            try
                                                                                            {
                                                                                                dummydate2 = row[15].ToString();
                                                                                                length = dummydate2.Length;
                                                                                                pos1 = dummydate2.IndexOf("/");
                                                                                                pos2 = dummydate2.Substring(pos1 + 1, length - pos1 - 1).IndexOf("/");
                                                                                                dummydate = dummydate2.Substring(pos1 + pos2 + 2, 4) + "-" + dummydate2.Substring(0, pos1) + "-" + dummydate2.Substring(pos1 + 1, pos2);

                                                                                                oSPListItem["Ημερομηνία Παράδοσης Προϊόντος"] = dummydate;
                                                                                            }
                                                                                            catch
                                                                                            {
                                                                                                //responseData.Append("Λάθος στο Ημερομηνία Παράδοσης Προϊόντος :" + dummydate + "<br>");
                                                                                            }
                                                                                        }

                                                                                        try
                                                                                        {
                                                                                            oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"] = Math.Round(decimal.Parse(row[17].ToString()), 2);
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                                        }

                                                                                        if (decimal.Parse(oSPListItem["Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό"].ToString()) < 0)
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Μέγιστη Μηνιαία Αξία Μεταφορών Κεφαλαίου στο Εξωτερικό :" + row[17].ToString() + "<br>");
                                                                                        }
                                                                                        try
                                                                                        {
                                                                                            oSPListItem["Συνολική Ετήσια Αξία"] = Math.Round(decimal.Parse(row[18].ToString()), 2);
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Συνολική Ετήσια Αξία :" + row[18].ToString() + "<br>");
                                                                                        }

                                                                                        try
                                                                                        {
                                                                                            oSPListItem["Όριο"] = Math.Round(decimal.Parse(row[17].ToString()) * 140 / 100, 2); //FYI: AG request
                                                                                        }
                                                                                        catch
                                                                                        {
                                                                                            responseData.Append("Λάθος στο Μηνιαίο Όριο ΠΝΠ :" + row[17].ToString() + "<br>");
                                                                                        }



                                                                                        if (FileUpload2.HasFile == true && noLines < 2)
                                                                                        {
                                                                                            string fname2 = "Αίτηση_" + Path.GetFileName(FileUpload2.PostedFile.FileName.ToString());
                                                                                            byte[] textfile2 = FileUpload2.FileBytes;
                                                                                            oSPListItem.Attachments.Add(fname2, textfile2);
                                                                                        }

                                                                                        if (FileUpload3.HasFile == true && noLines < 2)
                                                                                        {
                                                                                            string fname3 = "Δήλωση_" + Path.GetFileName(FileUpload3.PostedFile.FileName.ToString());
                                                                                            byte[] textfile3 = FileUpload3.FileBytes;
                                                                                            oSPListItem.Attachments.Add(fname3, textfile3);
                                                                                        }

                                                                                        if (FileUpload4.HasFile == true && noLines < 2)
                                                                                        {
                                                                                            string fname4 = "Τιμ_" + Path.GetFileName(FileUpload4.PostedFile.FileName.ToString());
                                                                                            byte[] textfile4 = FileUpload4.FileBytes;
                                                                                            oSPListItem.Attachments.Add(fname4, textfile4);
                                                                                        }
                                                                                        oWeb.AllowUnsafeUpdates = true;
                                                                                        oSPListItem.Update();
                                                                                        oWeb.AllowUnsafeUpdates = false;
                                                                                        addedIDs.Add(oSPListItem.ID);
                                                                                        katastimaurl = webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                        //katastimaurl4source = webapp + "/" + oList.RootFolder.Url.ToString();
                                                                                        //katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                                        if (katastimaurl.Length < 255)
                                                                                        {
                                                                                            katastimaurl4source = HttpUtility.UrlEncode(katastimaurl);
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            string katastimaurlsmall = oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString();
                                                                                            if (katastimaurlsmall.Length < 255)
                                                                                            {
                                                                                                katastimaurl4source = HttpUtility.UrlEncode(katastimaurlsmall);
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                katastimaurl4source = "/";
                                                                                            }
                                                                                        }
                                                                                        katastimaurl2 = "Κατάστημα: <a href='" + webapp + "/" + oList.RootFolder.Url.ToString() + "/" + dd_katastimata.SelectedValue.ToString() + "?Source=" + katastimaurl4source + "' target=_blank >" + dd_katastimata.SelectedValue.ToString() + "</a><br>";
                                                                                        //responseData.Append("εγγραφή: <a href='" + webapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + row[16].ToString() + " και νόμισμα " + row[6].ToString() + "<br>");
                                                                                        string newwebapp = webapp;
                                                                                        if (webapp.IndexOf("TODO") > 0)
                                                                                        {
                                                                                            newwebapp = webapp.Substring(0, webapp.IndexOf("TODO"));
                                                                                        }
                                                                                        //responseData.Append("<br>newwebapp2:" + newwebapp+"<br>");
                                                                                        if (row[6].ToString().ToUpper().Equals("EUR"))
                                                                                        {
                                                                                            responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            if (oSPListItem["Ισότιμο σε ΕΥΡΩ"] == null)
                                                                                            {
                                                                                                responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " καταχωρήθηκε!<br>");
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                responseData.Append("<a href='" + newwebapp + oList.DefaultEditFormUrl.ToString() + "?ID=" + oSPListItem.ID + "&Source=" + katastimaurl4source + "' target=_blank>" + kodikosaitimatos + "</a> με Ποσό: " + oSPListItem["Ποσό Παραστατικού"].ToString() + " " + row[6].ToString() + " & ισότιμο €: " + oSPListItem["Ισότιμο σε ΕΥΡΩ"].ToString() + " καταχωρήθηκε!<br>");
                                                                                            }
                                                                                        }
                                                                                        #endregion
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        #region different currency
                                                                                        responseData.Append("στην γραμμή " + noLines + " υπάρχει διαφορετικό νόμισμα!<br>");
                                                                                        foreach (int itmID in addedIDs)
                                                                                        {
                                                                                            SPListItem tobeDeleted = oList.GetItemById(itmID);
                                                                                            tobeDeleted.Delete();
                                                                                            responseData.Append("εγγραφή με id " + itmID.ToString() + " διαγράφηκε λόγω διαφορετικων νομισμάτων στο ίδιο αρχείο!<br>");
                                                                                        }
                                                                                        break;
                                                                                        #endregion
                                                                                    }
                                                                                }


                                                                            }
                                                                            catch (Exception ex)
                                                                            {
                                                                                responseData.Append("test2" + ex.ToString() + "<br>");
                                                                            }
                                                                            #endregion
                                                                        }// end else if afm
                                                                        #endregion
                                                                    }// end if Σύνολο
                                                                }//end using oweb
                                                            }//end using osite

                                                            #endregion
                                                        }//dtCSV.Columns.Count == 19
                                                        else
                                                        {
                                                            responseData.Append("Λάθος Πεδία (" + dtCSV.Columns.Count.ToString() + ") στην γραμμή : " + noLines + "<br>");
                                                        }//end else columns
                                                    } //end for each datarow
                                                    #endregion
                                                }//end if validated
                                                else
                                                {
                                                    responseData.Append("<font color='red'>Το αρχείο έχει λάθη και δεν μπορεί να εισαχθεί!</font>");
                                                }//end else if validated
                                            }
                                        }
                                    });// end elevated priviledges

                                }//end try
                                catch (Exception ex)
                                {
                                    Log(string.Format("(250): {0}", ex.InnerException == null ? ex.Message : ex.InnerException.Message));
                                    responseData.Append("Λανθασμένο ΑΦΜ (" + afm.Text + ")<br>" + strFilePath + "<br>");
                                    responseData.Append(ex.ToString());
                                }
                            } //end if xls
                            #region result
                            if (noLines == 0)
                            {
                                responseData.Insert(0, "Δεν βρέθηκαν εγγραφές! στο αρχείο " + fname + "<br>");
                            }
                            else
                            {
                                if (noLines == 1)
                                {
                                    //FYI: changes -- 20151203 (nolines - 1 to nolines)
                                    responseData.Insert(0, "Ολοκληρώθηκε η επεξεργασία " + noLines.ToString() + " εγγραφής που επεξεργάστηκε από το αρχείο " + fname + "<br>" + katastimaurl2);
                                }
                                else
                                {
                                    responseData.Insert(0, "Ολοκληρώθηκε η επεξεργασία " + noLines.ToString() + " εγγραφών που επεξεργάστηκαν από το αρχείο " + fname + "<br>" + katastimaurl2);
                                }
                            #endregion
                            }
                            #endregion
                        }//end if file 1 has file
                        else
                        {
                            responseData.Append("<font color='red'><b>Δεν βρέθηκε αρχείο εισαγωγής!</b></font><br>");
                        }

                        Label1.Text = responseData.ToString();
                        //Log(responseData.ToString());
                        Log(string.Format("End-- Κατάστημα: {0}, ΑΦΜ: {1}, File: {2}", dd_katastimata.SelectedValue, afm.Text, Path.GetFileName(FileUpload1.PostedFile.FileName)));
                    }
                    else
                    {
                        Label1.Text = "<font color='red'>το ΑΦΜ δεν είναι έγκυρο!</font>";
                    }
                }
                else
                {
                    //ts.Hours+":"+ts.Days+":
                    Label1.Text = "<font color='red'>η ημερομηνία Υποβολής αιτήματος από Πελάτη (" + datepel.SelectedDate.ToShortDateString() + ") πρέπει να είναι ίση ή μικρότερη και όχι πάνω από 30 ημέρες από την σημερινή (" + DateTime.Now.ToShortDateString() + ")!</font>";
                }


            }// end master try
            catch (Exception ex)
            {
                Label1.Text = ex.ToString();
            }
        }

        private void RemoveRedundantColumns(DataTable dtCSV)
        {
            if (dtCSV.Columns.Count > 19)
            {
                while (dtCSV.Columns.Count > 19)
                {
                    dtCSV.Columns.RemoveAt(19);
                }
            }
        }

        private decimal GetSumToEuro(DataTable dtCSV, StringBuilder responseData)
        {
            try
            {
                object[] firstline = dtCSV.Rows[1].ItemArray;
                string currency = firstline[6].ToString();

                decimal currentRate = GetCurrentRate(currency);
                Log(string.Format("GetSumToEuro -- currentRate:{0}", currentRate));

                decimal parsedPoso = 0m; decimal isotimoSeEuro = 0m; decimal sum = 0m; decimal sumToEuro = 0m; int line = 0;
                string fromExcel = string.Empty;

                foreach (DataRow row in dtCSV.Rows)
                {
                    if (FirstColumnHasValue(row))
                    {
                        line++;

                        fromExcel = row[16].ToString();
                        parsedPoso = this.ToDecimalParsed(row[16].ToString());

                        isotimoSeEuro = Math.Round((parsedPoso / currentRate), 2);
                        Log(string.Format("GetSumToEuro -- line:{0}, fromExcel:{1}, parsedPoso:{2}, isotimo se euro:{3}", line, fromExcel, parsedPoso, isotimoSeEuro));

                        sum += parsedPoso;
                        sumToEuro += isotimoSeEuro;

                        Log(string.Format("GetSumToEuro -- line:{0}, current sum:{1}, sum se euro:{2}", line, sum, sumToEuro));
                    }
                }

                //Log(string.Format("GetSumToEuro -- teliko sum:{0}, sum se euro:{1}", sum, sumToEuro));
                return sumToEuro;
            }
            catch(Exception ex)
            {
                Log(string.Format("GetSumToEuro -- {0}", ex.Message));
                return -1;
            }
        }

        decimal ToDecimalParsed(string input)
        {
            /*
            var ci = CultureInfo.CreateSpecificCulture(culture);
            decimal result = decimal.Parse(input, ci);

            var numberStyle = NumberStyles.AllowLeadingSign;
            decimal result =  decimal.Parse(input, numberStyle, ci);
             */

            decimal result;
            
            if (input.LastIndexOf(",") != -1)
                result = decimal.Parse(input, CultureInfo.CreateSpecificCulture("el-GR"));
            else if (input.LastIndexOf(".") != -1)
                result = decimal.Parse(input, CultureInfo.CreateSpecificCulture("en-US"));
            else
                result = decimal.Parse(input);

            return result;
        }

        bool AreAllValidColumnsEmpty(DataRow dr)
        {
            if (dr == null) return true;

            foreach (var value in dr.ItemArray)
            {
                string s = Convert.ToString(value);
                if (!string.IsNullOrWhiteSpace(s) && !s.StartsWith("Πελάτης / Εντολέας", StringComparison.InvariantCultureIgnoreCase))
                {
                    return false;
                }
            }
            return true;
        }

        bool FirstColumnHasValue(DataRow dr)
        {
            if (dr == null) return false;

            var firstColumn = dr.ItemArray[0];
            var firstColumnAsString = Convert.ToString(firstColumn);

            if (!string.IsNullOrWhiteSpace(firstColumnAsString)
                && !firstColumnAsString.StartsWith("Πελάτης / Εντολέας", StringComparison.InvariantCultureIgnoreCase))
            {
                return true;
            }

            return false;
        }

        //decimal ToDecimal(string inputText, int lineNo)
        //{
        //    var culture = CultureInfo.CreateSpecificCulture("el-GR");
        //    decimal amount = decimal.Parse(inputText, culture);

        //    //Log(string.Format("line:{0}, input:{1}, formatedInput:{2}, parsed:{3}", lineNo, inputText, formatedInput, amount));
        //    Log(string.Format("line:{0}, input:{1}, parsed:{2}", lineNo, inputText, amount));

        //    return Math.Round(amount, 2);
        //}

        decimal GetCurrentRate(string currency)
        {
            decimal rateMtf = 1.0m;

            using (SPSite oSite = new SPSite(webapp))
            {
                using (SPWeb web = oSite.RootWeb)
                {
                    SPList rates = web.Lists["Rates"];
                    SPQuery oQuery = new SPQuery();

                    oQuery.Query = "<Where><And><Eq><FieldRef Name='Title'/>" +
                        "<Value Type='Text'>" + currency + "</Value></Eq>" +
                        "<Eq><FieldRef Name='RateDate'/><Value Type='DateTime'>" + DateTime.Now.ToString("yyyy-MM-dd") + "</Value></Eq></And></Where>";
                    SPListItemCollection collListItems = rates.GetItems(oQuery);

                    foreach (SPListItem oListItem in collListItems)
                    {
                        if (oListItem["RateMTF"].ToString() != null)
                        {
                            rateMtf = ToDecimalParsed(oListItem["RateMTF"].ToString());
                            break;
                        }
                    }
                }
            }

            return rateMtf;
        }

        void Log(string msg)
        {
            try
            {
                SPSecurity.RunWithElevatedPrivileges(delegate()
                {
                    using (SPSite oSite = new SPSite(webapp))
                    {
                        using (SPWeb oWeb = oSite.RootWeb)
                        {
                            SPList dbglist;
                            if (oWeb.Url.Contains("dev"))
                                dbglist = oWeb.GetList("/Lists/debuglist");
                            else
                                dbglist = oWeb.GetList("/TODO/pnpdemands/Lists/debuglist");


                            SPListItem dbgitm = dbglist.Items.Add();
                            dbgitm["module"] = "WP addcsv4";
                            if (msg.Length < 254)
                            {
                                dbgitm["Title"] = msg;
                            }
                            else
                            {
                                dbgitm["Title"] = msg.Substring(0, 100) + "...";
                                dbgitm["details"] = msg;
                            }

                            oWeb.AllowUnsafeUpdates = true;
                            dbgitm.Update();
                            oWeb.AllowUnsafeUpdates = false;
                        }
                    }
                });
            }//end try
            catch (Exception ex)
            {
                using (StreamWriter w = File.AppendText("C:\\TEMP\\WPaddcsv_log.txt"))
                {
                    w.WriteLine(DateTime.Now.ToString("yyyy-MM-dd hh:mm:ss") + ": " + "Error in debug List :" + ex.ToString());
                }
            }
        }

        public bool CheckAFM(string afm)
        {
            if (afm.Equals("999999999") || afm.Equals("888888888"))
            {
                return true;
            }
            else
            {
                if (afm.Length != 9)
                    return false;
                var digits = afm.ToCharArray();
                int checkDigit = digits[8] - 48;
                long sum = ((digits[7] - 48) << 1) +
                    ((digits[6] - 48) << 2) +
                    ((digits[5] - 48) << 3) +
                    ((digits[4] - 48) << 4) +
                    ((digits[3] - 48) << 5) +
                    ((digits[2] - 48) << 6) +
                    ((digits[1] - 48) << 7) +
                    ((digits[0] - 48) << 8);
                long mod = sum % 11;
                if (mod == 10)
                    mod = 0;
                return (mod == checkDigit);
            }
        }

        //void PrintTestData()
        //{
        //    decimal parsedPoso = 0m; decimal isotimoSeEuro = 0m; decimal sum = 0m; decimal sumToEuro = 0m; int line = 0;
        //    string posoAsString = string.Empty;

        //    var responseData = new StringBuilder();
        //    string strFilePath = "";
        //    bool filevalidated = true;

        //    TrySaveExcelFile("ΕΕΤΣ_ΥΕΤΣ_" + afm.Text + "$", responseData, out strFilePath, out filevalidated);

        //    DataTable dtCSV = TryOpenExcelFile("ΕΕΤΣ_ΥΕΤΣ_" + afm.Text + "$", strFilePath, responseData, out filevalidated);

        //    object[] firstline = dtCSV.Rows[1].ItemArray;
        //    string currency = firstline[6].ToString();
        //    decimal currentRate = GetCurrentRate(currency);

        //    responseData.AppendLine("Rate: " + currentRate.ToString() + "<br>");

        //    foreach (DataRow row in dtCSV.Rows)
        //    {
        //        line++;

        //        object[] excelItem = row.ItemArray;
        //        posoAsString = excelItem[16].ToString();

        //        if (!string.IsNullOrWhiteSpace(posoAsString))
        //        {
        //            parsedPoso = decimal.Parse(posoAsString);
        //            isotimoSeEuro = Math.Round((parsedPoso / currentRate), 2);

        //            sum += parsedPoso;
        //            sumToEuro += isotimoSeEuro;

        //            string item = string.Format("line: {0}-- \t\tΠοσό: {1}-- \t\tSum: {2}-- \t\tSum se Euro:{3}", line, parsedPoso, sum, sumToEuro);

        //            responseData.AppendLine(item + "<br>");
        //        }
        //    }

        //    lbData.Text = responseData.ToString();
        //}

        bool IsTestEnvironment(string url)
        {
            return url.ToLower().Contains("dev") || url.ToLower().Contains("test");
        }
    }
}
